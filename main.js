/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var nt=Object.defineProperty;var Rr=Object.getOwnPropertyDescriptor;var _r=Object.getOwnPropertyNames;var Nr=Object.prototype.hasOwnProperty;var B=(e,n)=>()=>(e&&(n=e(e=0)),n);var Ce=(e,n)=>{for(var t in n)nt(e,t,{get:n[t],enumerable:!0})},Ir=(e,n,t,r)=>{if(n&&typeof n=="object"||typeof n=="function")for(let i of _r(n))!Nr.call(e,i)&&i!==t&&nt(e,i,{get:()=>n[i],enumerable:!(r=Rr(n,i))||r.enumerable});return e};var Mr=e=>Ir(nt({},"__esModule",{value:!0}),e);function it(e){let n=new Date().toISOString().replace("T"," ").substring(0,19);return{title:e.title||"Unknown Title",subtitle:e.subtitle,author:e.author||[],isbn10:e.isbn10,isbn13:e.isbn13,publisher:e.publisher,publishDate:e.publishDate,totalPages:e.totalPages,coverUrl:e.coverUrl,category:e.category||[],coverEditionKey:e.coverEditionKey,status:e.status||"unread",readPage:e.readPage||0,readStarted:e.readStarted,readFinished:e.readFinished,created:e.created||n,updated:e.updated||n}}var Tt=B(()=>{});var St,Se,At=B(()=>{St=require("obsidian"),Se=class{constructor(n=5e3){this.timeout=n}async get(n){try{let t=await(0,St.requestUrl)({url:n,method:"GET",throw:!1});if(t.status>=400)throw new Error(`Request failed with status ${t.status}`);return t.json}catch(t){throw new Error("Request failed. Please try again later.")}}}});var Ae,Bt=B(()=>{Tt();At();Ae=class{constructor(n=5e3){this.baseUrl="https://openlibrary.org";this.httpClient=new Se(n)}async searchBooks(n,t=20,r=0){try{let i=encodeURIComponent(n),s=`${this.baseUrl}/search.json?q=${i}&limit=${t}&offset=${r}`,o=await this.httpClient.get(s);return this.convertSearchDocsToBooks(o.docs)}catch(i){throw new Error("Failed to search books. Please try again later.")}}async getBookByOLID(n){try{let t=`${this.baseUrl}/books/${n}.json`,r=await this.httpClient.get(t),i=await this.fetchWorkDetails(r);return this.convertEditionToBook(r,i)}catch(t){return console.error("[OpenLibrary] Error fetching book by OLID:",t),null}}async fetchWorkDetails(n){if(!n.works||n.works.length===0)return null;let t=n.works[0];if(!(t!=null&&t.key))return null;try{let r=`${this.baseUrl}${t.key}.json`;return await this.httpClient.get(r)}catch(r){return null}}getBookCover(n,t="M"){let r={S:"-S",M:"-M",L:"-L"};return typeof n=="number"?`https://covers.openlibrary.org/b/id/${n}${r[t]}.jpg`:`https://covers.openlibrary.org/b/isbn/${n}${r[t]}.jpg`}convertEditionToBook(n,t,r){var c,d,p,u,h,x,g;let i=this.extractAuthors(n),s=((c=n.isbn_10)==null?void 0:c[0])||(r&&r.length===10?r:void 0),o=((d=n.isbn_13)==null?void 0:d[0])||(r&&r.length===13?r:void 0),a=this.extractCoverUrl(n,o,s),l=(p=n.number_of_pages)!=null?p:t==null?void 0:t.number_of_pages;return it({title:n.title||(t==null?void 0:t.title)||"",subtitle:n.subtitle||(t==null?void 0:t.subtitle),author:i,isbn10:s,isbn13:o,publisher:((u=n.publishers)==null?void 0:u[0])||((h=t==null?void 0:t.publishers)==null?void 0:h[0]),publishDate:n.publish_date||(t==null?void 0:t.publish_date),totalPages:l,coverUrl:a,category:((x=n.subjects)==null?void 0:x.slice(0,5))||((g=t==null?void 0:t.subjects)==null?void 0:g.slice(0,5))||[]})}extractAuthors(n){return!n.authors||!Array.isArray(n.authors)?[]:n.authors.map(t=>t.name||"").filter(t=>t.length>0)}extractCoverUrl(n,t,r){if(n.covers&&n.covers.length>0&&n.covers[0]!==void 0)return this.getBookCover(n.covers[0],"M");if(t)return this.getBookCover(t,"M");if(r)return this.getBookCover(r,"M")}convertSearchDocToBook(n){var a,l,c,d,p;let t=n.author_name||[],r=n.cover_i?this.getBookCover(n.cover_i,"M"):void 0,i=n.first_publish_year||((a=n.publish_year)==null?void 0:a[0]),s=i?i.toString():(l=n.publish_date)==null?void 0:l[0],o=(c=n.number_of_pages_median)!=null?c:n.number_of_pages;return it({title:n.title,subtitle:n.subtitle,author:t,isbn10:void 0,isbn13:void 0,publisher:(d=n.publisher)==null?void 0:d[0],publishDate:s,totalPages:o,coverUrl:r,category:(p=n.subject)==null?void 0:p.slice(0,5),coverEditionKey:n.cover_edition_key})}convertSearchDocsToBooks(n){return n.map(t=>this.convertSearchDocToBook(t))}}});var Be,re,ot=B(()=>{Be=require("obsidian"),re=class{constructor(n){this.app=n}async ensureFolder(n){let t=(0,Be.normalizePath)(n),r=this.app.vault.getAbstractFileByPath(t);if(!r)await this.app.vault.createFolder(t);else if(!(r instanceof Be.TFolder))throw new Error(`Path exists but is not a folder: ${t}`)}}});var ne,st=B(()=>{ne=class{static generate(n){let t=n.replace(/[<>:"/\\|?*]/g,"").replace(/\s+/g," ").trim(),r=100;return(t.length>r?t.substring(0,r).trim():t)||"Untitled Book"}}});var Pe,L,Fe=B(()=>{Pe=require("obsidian"),L=class{static getBooksFolderPath(n){return(0,Pe.normalizePath)(`${n}/Books`)}static getInteractionFolderPath(n){return(0,Pe.normalizePath)(`${n}/.bookshelf`)}static getViewsFolderPath(n){return(0,Pe.normalizePath)(`${n}/Views`)}}});var Pt={};Ce(Pt,{formatDate:()=>fe,getCurrentDate:()=>$r,getCurrentDateTime:()=>R,getTimezoneOffset:()=>Or,setTimezoneOffset:()=>De});function De(e){at=e}function Or(){return at}function fe(e,n="YYYY-MM-DD HH:mm:ss"){let t=typeof e=="string"?new Date(e):e,r=t.getTime()+t.getTimezoneOffset()*6e4,i=new Date(r+at*36e5),s=i.getFullYear(),o=String(i.getMonth()+1).padStart(2,"0"),a=String(i.getDate()).padStart(2,"0"),l=String(i.getHours()).padStart(2,"0"),c=String(i.getMinutes()).padStart(2,"0"),d=String(i.getSeconds()).padStart(2,"0");return n.replace(/YYYY/g,String(s)).replace(/MM/g,o).replace(/DD/g,a).replace(/HH/g,l).replace(/mm/g,c).replace(/ss/g,d)}function R(){return fe(new Date,"YYYY-MM-DD HH:mm:ss")}function $r(){return fe(new Date,"YYYY-MM-DD")}var at,Q=B(()=>{at=0});var z,Le=B(()=>{Q();z=class e{static bookToFrontmatter(n){let t=R(),r=n.created||t,i={title:n.title||"",subtitle:n.subtitle||"",author:n.author||[],category:n.category||[],publisher:n.publisher||"",publish:n.publishDate||"",isbn:"",cover:n.coverUrl||"",total:0,status:n.status||"unread",read_page:n.readPage||0,read_started:n.readStarted!==void 0?n.readStarted:r,read_finished:n.readFinished||null,created:r,updated:n.updated||t};n.totalPages!==void 0&&n.totalPages!==null&&!isNaN(n.totalPages)&&(i.total=n.totalPages);let s=`${n.isbn10||""} ${n.isbn13||""}`.trim();return s&&(i.isbn=s),i}static frontmatterToBook(n){let{isbn10:t,isbn13:r}=e.extractIsbn(n.isbn),i=e.calculateReadPage(n),s=n.status,o=s==="unread"||s==="reading"||s==="finished"?s:"unread";return{title:n.title||"",subtitle:n.subtitle,author:Array.isArray(n.author)?n.author:[],category:Array.isArray(n.category)?n.category:[],publisher:n.publisher,publishDate:n.publish,totalPages:typeof n.total=="number"?n.total:void 0,isbn10:t,isbn13:r,coverUrl:n.cover,status:o,readPage:i,readStarted:n.read_started,readFinished:n.read_finished!==null?n.read_finished:void 0,created:n.created||R(),updated:n.updated||R()}}static extractIsbn(n){let t,r;if(n){let i=String(n).trim().split(/\s+/);for(let s of i)s.length===10?t=s:s.length===13&&(r=s)}return{isbn10:t,isbn13:r}}static calculateReadPage(n){let t=typeof n.read_page=="number"?n.read_page:0;if(n.reading_history_summary&&Array.isArray(n.reading_history_summary)){let r=n.reading_history_summary.reduce((i,s)=>i+(s.pagesRead||0),0);r>t&&(t=r)}return t}}});function Vt(e){return typeof e=="undefined"||e===null}function Hr(e){return typeof e=="object"&&e!==null}function Ur(e){return Array.isArray(e)?e:Vt(e)?[]:[e]}function zr(e,n){var t,r,i,s;if(n)for(s=Object.keys(n),t=0,r=s.length;t<r;t+=1)i=s[t],e[i]=n[i];return e}function jr(e,n){var t="",r;for(r=0;r<n;r+=1)t+=e;return t}function Yr(e){return e===0&&Number.NEGATIVE_INFINITY===1/e}function qt(e,n){var t="",r=e.reason||"(unknown reason)";return e.mark?(e.mark.name&&(t+='in "'+e.mark.name+'" '),t+="("+(e.mark.line+1)+":"+(e.mark.column+1)+")",!n&&e.mark.snippet&&(t+=`

`+e.mark.snippet),r+" "+t):r}function me(e,n){Error.call(this),this.name="YAMLException",this.reason=e,this.mark=n,this.message=qt(this,!1),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack||""}function lt(e,n,t,r,i){var s="",o="",a=Math.floor(i/2)-1;return r-n>a&&(s=" ... ",n=r-a+s.length),t-r>a&&(o=" ...",t=r+a-o.length),{str:s+e.slice(n,t).replace(/\t/g,"\u2192")+o,pos:r-n+s.length}}function ct(e,n){return A.repeat(" ",n-e.length)+e}function Qr(e,n){if(n=Object.create(n||null),!e.buffer)return null;n.maxLength||(n.maxLength=79),typeof n.indent!="number"&&(n.indent=1),typeof n.linesBefore!="number"&&(n.linesBefore=3),typeof n.linesAfter!="number"&&(n.linesAfter=2);for(var t=/\r?\n|\r|\0/g,r=[0],i=[],s,o=-1;s=t.exec(e.buffer);)i.push(s.index),r.push(s.index+s[0].length),e.position<=s.index&&o<0&&(o=r.length-2);o<0&&(o=r.length-1);var a="",l,c,d=Math.min(e.line+n.linesAfter,i.length).toString().length,p=n.maxLength-(n.indent+d+3);for(l=1;l<=n.linesBefore&&!(o-l<0);l++)c=lt(e.buffer,r[o-l],i[o-l],e.position-(r[o]-r[o-l]),p),a=A.repeat(" ",n.indent)+ct((e.line-l+1).toString(),d)+" | "+c.str+`
`+a;for(c=lt(e.buffer,r[o],i[o],e.position,p),a+=A.repeat(" ",n.indent)+ct((e.line+1).toString(),d)+" | "+c.str+`
`,a+=A.repeat("-",n.indent+d+3+c.pos)+`^
`,l=1;l<=n.linesAfter&&!(o+l>=i.length);l++)c=lt(e.buffer,r[o+l],i[o+l],e.position-(r[o]-r[o+l]),p),a+=A.repeat(" ",n.indent)+ct((e.line+l+1).toString(),d)+" | "+c.str+`
`;return a.replace(/\n$/,"")}function tn(e){var n={};return e!==null&&Object.keys(e).forEach(function(t){e[t].forEach(function(r){n[String(r)]=t})}),n}function rn(e,n){if(n=n||{},Object.keys(n).forEach(function(t){if(Xr.indexOf(t)===-1)throw new _('Unknown option "'+t+'" is met in definition of "'+e+'" YAML type.')}),this.options=n,this.tag=e,this.kind=n.kind||null,this.resolve=n.resolve||function(){return!0},this.construct=n.construct||function(t){return t},this.instanceOf=n.instanceOf||null,this.predicate=n.predicate||null,this.represent=n.represent||null,this.representName=n.representName||null,this.defaultStyle=n.defaultStyle||null,this.multi=n.multi||!1,this.styleAliases=tn(n.styleAliases||null),en.indexOf(this.kind)===-1)throw new _('Unknown kind "'+this.kind+'" is specified for "'+e+'" YAML type.')}function Ft(e,n){var t=[];return e[n].forEach(function(r){var i=t.length;t.forEach(function(s,o){s.tag===r.tag&&s.kind===r.kind&&s.multi===r.multi&&(i=o)}),t[i]=r}),t}function nn(){var e={scalar:{},sequence:{},mapping:{},fallback:{},multi:{scalar:[],sequence:[],mapping:[],fallback:[]}},n,t;function r(i){i.multi?(e.multi[i.kind].push(i),e.multi.fallback.push(i)):e[i.kind][i.tag]=e.fallback[i.tag]=i}for(n=0,t=arguments.length;n<t;n+=1)arguments[n].forEach(r);return e}function pt(e){return this.extend(e)}function dn(e){if(e===null)return!0;var n=e.length;return n===1&&e==="~"||n===4&&(e==="null"||e==="Null"||e==="NULL")}function pn(){return null}function un(e){return e===null}function fn(e){if(e===null)return!1;var n=e.length;return n===4&&(e==="true"||e==="True"||e==="TRUE")||n===5&&(e==="false"||e==="False"||e==="FALSE")}function gn(e){return e==="true"||e==="True"||e==="TRUE"}function mn(e){return Object.prototype.toString.call(e)==="[object Boolean]"}function bn(e){return 48<=e&&e<=57||65<=e&&e<=70||97<=e&&e<=102}function yn(e){return 48<=e&&e<=55}function vn(e){return 48<=e&&e<=57}function kn(e){if(e===null)return!1;var n=e.length,t=0,r=!1,i;if(!n)return!1;if(i=e[t],(i==="-"||i==="+")&&(i=e[++t]),i==="0"){if(t+1===n)return!0;if(i=e[++t],i==="b"){for(t++;t<n;t++)if(i=e[t],i!=="_"){if(i!=="0"&&i!=="1")return!1;r=!0}return r&&i!=="_"}if(i==="x"){for(t++;t<n;t++)if(i=e[t],i!=="_"){if(!bn(e.charCodeAt(t)))return!1;r=!0}return r&&i!=="_"}if(i==="o"){for(t++;t<n;t++)if(i=e[t],i!=="_"){if(!yn(e.charCodeAt(t)))return!1;r=!0}return r&&i!=="_"}}if(i==="_")return!1;for(;t<n;t++)if(i=e[t],i!=="_"){if(!vn(e.charCodeAt(t)))return!1;r=!0}return!(!r||i==="_")}function En(e){var n=e,t=1,r;if(n.indexOf("_")!==-1&&(n=n.replace(/_/g,"")),r=n[0],(r==="-"||r==="+")&&(r==="-"&&(t=-1),n=n.slice(1),r=n[0]),n==="0")return 0;if(r==="0"){if(n[1]==="b")return t*parseInt(n.slice(2),2);if(n[1]==="x")return t*parseInt(n.slice(2),16);if(n[1]==="o")return t*parseInt(n.slice(2),8)}return t*parseInt(n,10)}function wn(e){return Object.prototype.toString.call(e)==="[object Number]"&&e%1===0&&!A.isNegativeZero(e)}function Sn(e){return!(e===null||!Tn.test(e)||e[e.length-1]==="_")}function An(e){var n,t;return n=e.replace(/_/g,"").toLowerCase(),t=n[0]==="-"?-1:1,"+-".indexOf(n[0])>=0&&(n=n.slice(1)),n===".inf"?t===1?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:n===".nan"?NaN:t*parseFloat(n,10)}function Pn(e,n){var t;if(isNaN(e))switch(n){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===e)switch(n){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===e)switch(n){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(A.isNegativeZero(e))return"-0.0";return t=e.toString(10),Bn.test(t)?t.replace("e",".e"):t}function Fn(e){return Object.prototype.toString.call(e)==="[object Number]"&&(e%1!==0||A.isNegativeZero(e))}function _n(e){return e===null?!1:Wt.exec(e)!==null||Gt.exec(e)!==null}function Nn(e){var n,t,r,i,s,o,a,l=0,c=null,d,p,u;if(n=Wt.exec(e),n===null&&(n=Gt.exec(e)),n===null)throw new Error("Date resolve error");if(t=+n[1],r=+n[2]-1,i=+n[3],!n[4])return new Date(Date.UTC(t,r,i));if(s=+n[4],o=+n[5],a=+n[6],n[7]){for(l=n[7].slice(0,3);l.length<3;)l+="0";l=+l}return n[9]&&(d=+n[10],p=+(n[11]||0),c=(d*60+p)*6e4,n[9]==="-"&&(c=-c)),u=new Date(Date.UTC(t,r,i,s,o,a,l)),c&&u.setTime(u.getTime()-c),u}function In(e){return e.toISOString()}function On(e){return e==="<<"||e===null}function Hn(e){if(e===null)return!1;var n,t,r=0,i=e.length,s=mt;for(t=0;t<i;t++)if(n=s.indexOf(e.charAt(t)),!(n>64)){if(n<0)return!1;r+=6}return r%8===0}function Un(e){var n,t,r=e.replace(/[\r\n=]/g,""),i=r.length,s=mt,o=0,a=[];for(n=0;n<i;n++)n%4===0&&n&&(a.push(o>>16&255),a.push(o>>8&255),a.push(o&255)),o=o<<6|s.indexOf(r.charAt(n));return t=i%4*6,t===0?(a.push(o>>16&255),a.push(o>>8&255),a.push(o&255)):t===18?(a.push(o>>10&255),a.push(o>>2&255)):t===12&&a.push(o>>4&255),new Uint8Array(a)}function zn(e){var n="",t=0,r,i,s=e.length,o=mt;for(r=0;r<s;r++)r%3===0&&r&&(n+=o[t>>18&63],n+=o[t>>12&63],n+=o[t>>6&63],n+=o[t&63]),t=(t<<8)+e[r];return i=s%3,i===0?(n+=o[t>>18&63],n+=o[t>>12&63],n+=o[t>>6&63],n+=o[t&63]):i===2?(n+=o[t>>10&63],n+=o[t>>4&63],n+=o[t<<2&63],n+=o[64]):i===1&&(n+=o[t>>2&63],n+=o[t<<4&63],n+=o[64],n+=o[64]),n}function jn(e){return Object.prototype.toString.call(e)==="[object Uint8Array]"}function Wn(e){if(e===null)return!0;var n=[],t,r,i,s,o,a=e;for(t=0,r=a.length;t<r;t+=1){if(i=a[t],o=!1,qn.call(i)!=="[object Object]")return!1;for(s in i)if(Vn.call(i,s))if(!o)o=!0;else return!1;if(!o)return!1;if(n.indexOf(s)===-1)n.push(s);else return!1}return!0}function Gn(e){return e!==null?e:[]}function Qn(e){if(e===null)return!0;var n,t,r,i,s,o=e;for(s=new Array(o.length),n=0,t=o.length;n<t;n+=1){if(r=o[n],Jn.call(r)!=="[object Object]"||(i=Object.keys(r),i.length!==1))return!1;s[n]=[i[0],r[i[0]]]}return!0}function Zn(e){if(e===null)return[];var n,t,r,i,s,o=e;for(s=new Array(o.length),n=0,t=o.length;n<t;n+=1)r=o[n],i=Object.keys(r),s[n]=[i[0],r[i[0]]];return s}function ti(e){if(e===null)return!0;var n,t=e;for(n in t)if(ei.call(t,n)&&t[n]!==null)return!1;return!0}function ri(e){return e!==null?e:{}}function Lt(e){return Object.prototype.toString.call(e)}function M(e){return e===10||e===13}function X(e){return e===9||e===32}function N(e){return e===9||e===32||e===10||e===13}function oe(e){return e===44||e===91||e===93||e===123||e===125}function li(e){var n;return 48<=e&&e<=57?e-48:(n=e|32,97<=n&&n<=102?n-97+10:-1)}function ci(e){return e===120?2:e===117?4:e===85?8:0}function di(e){return 48<=e&&e<=57?e-48:-1}function Rt(e){return e===48?"\0":e===97?"\x07":e===98?"\b":e===116||e===9?"	":e===110?`
`:e===118?"\v":e===102?"\f":e===114?"\r":e===101?"\x1B":e===32?" ":e===34?'"':e===47?"/":e===92?"\\":e===78?"\x85":e===95?"\xA0":e===76?"\u2028":e===80?"\u2029":""}function pi(e){return e<=65535?String.fromCharCode(e):String.fromCharCode((e-65536>>10)+55296,(e-65536&1023)+56320)}function Xt(e,n,t){n==="__proto__"?Object.defineProperty(e,n,{configurable:!0,enumerable:!0,writable:!0,value:t}):e[n]=t}function ui(e,n){this.input=e,this.filename=n.filename||null,this.schema=n.schema||xt,this.onWarning=n.onWarning||null,this.legacy=n.legacy||!1,this.json=n.json||!1,this.listener=n.listener||null,this.implicitTypes=this.schema.compiledImplicit,this.typeMap=this.schema.compiledTypeMap,this.length=e.length,this.position=0,this.line=0,this.lineStart=0,this.lineIndent=0,this.firstTabInLine=-1,this.documents=[]}function rr(e,n){var t={name:e.filename,buffer:e.input.slice(0,-1),position:e.position,line:e.line,column:e.position-e.lineStart};return t.snippet=Zr(t),new _(n,t)}function v(e,n){throw rr(e,n)}function Ne(e,n){e.onWarning&&e.onWarning.call(null,rr(e,n))}function q(e,n,t,r){var i,s,o,a;if(n<t){if(a=e.input.slice(n,t),r)for(i=0,s=a.length;i<s;i+=1)o=a.charCodeAt(i),o===9||32<=o&&o<=1114111||v(e,"expected valid JSON character");else oi.test(a)&&v(e,"the stream contains non-printable characters");e.result+=a}}function Nt(e,n,t,r){var i,s,o,a;for(A.isObject(t)||v(e,"cannot merge mappings; the provided source object is unacceptable"),i=Object.keys(t),o=0,a=i.length;o<a;o+=1)s=i[o],W.call(n,s)||(Xt(n,s,t[s]),r[s]=!0)}function se(e,n,t,r,i,s,o,a,l){var c,d;if(Array.isArray(i))for(i=Array.prototype.slice.call(i),c=0,d=i.length;c<d;c+=1)Array.isArray(i[c])&&v(e,"nested arrays are not supported inside keys"),typeof i=="object"&&Lt(i[c])==="[object Object]"&&(i[c]="[object Object]");if(typeof i=="object"&&Lt(i)==="[object Object]"&&(i="[object Object]"),i=String(i),n===null&&(n={}),r==="tag:yaml.org,2002:merge")if(Array.isArray(s))for(c=0,d=s.length;c<d;c+=1)Nt(e,n,s[c],t);else Nt(e,n,s,t);else!e.json&&!W.call(t,i)&&W.call(n,i)&&(e.line=o||e.line,e.lineStart=a||e.lineStart,e.position=l||e.position,v(e,"duplicated mapping key")),Xt(n,i,s),delete t[i];return n}function bt(e){var n;n=e.input.charCodeAt(e.position),n===10?e.position++:n===13?(e.position++,e.input.charCodeAt(e.position)===10&&e.position++):v(e,"a line break is expected"),e.line+=1,e.lineStart=e.position,e.firstTabInLine=-1}function S(e,n,t){for(var r=0,i=e.input.charCodeAt(e.position);i!==0;){for(;X(i);)i===9&&e.firstTabInLine===-1&&(e.firstTabInLine=e.position),i=e.input.charCodeAt(++e.position);if(n&&i===35)do i=e.input.charCodeAt(++e.position);while(i!==10&&i!==13&&i!==0);if(M(i))for(bt(e),i=e.input.charCodeAt(e.position),r++,e.lineIndent=0;i===32;)e.lineIndent++,i=e.input.charCodeAt(++e.position);else break}return t!==-1&&r!==0&&e.lineIndent<t&&Ne(e,"deficient indentation"),r}function Oe(e){var n=e.position,t;return t=e.input.charCodeAt(n),!!((t===45||t===46)&&t===e.input.charCodeAt(n+1)&&t===e.input.charCodeAt(n+2)&&(n+=3,t=e.input.charCodeAt(n),t===0||N(t)))}function yt(e,n){n===1?e.result+=" ":n>1&&(e.result+=A.repeat(`
`,n-1))}function hi(e,n,t){var r,i,s,o,a,l,c,d,p=e.kind,u=e.result,h;if(h=e.input.charCodeAt(e.position),N(h)||oe(h)||h===35||h===38||h===42||h===33||h===124||h===62||h===39||h===34||h===37||h===64||h===96||(h===63||h===45)&&(i=e.input.charCodeAt(e.position+1),N(i)||t&&oe(i)))return!1;for(e.kind="scalar",e.result="",s=o=e.position,a=!1;h!==0;){if(h===58){if(i=e.input.charCodeAt(e.position+1),N(i)||t&&oe(i))break}else if(h===35){if(r=e.input.charCodeAt(e.position-1),N(r))break}else{if(e.position===e.lineStart&&Oe(e)||t&&oe(h))break;if(M(h))if(l=e.line,c=e.lineStart,d=e.lineIndent,S(e,!1,-1),e.lineIndent>=n){a=!0,h=e.input.charCodeAt(e.position);continue}else{e.position=o,e.line=l,e.lineStart=c,e.lineIndent=d;break}}a&&(q(e,s,o,!1),yt(e,e.line-l),s=o=e.position,a=!1),X(h)||(o=e.position+1),h=e.input.charCodeAt(++e.position)}return q(e,s,o,!1),e.result?!0:(e.kind=p,e.result=u,!1)}function fi(e,n){var t,r,i;if(t=e.input.charCodeAt(e.position),t!==39)return!1;for(e.kind="scalar",e.result="",e.position++,r=i=e.position;(t=e.input.charCodeAt(e.position))!==0;)if(t===39)if(q(e,r,e.position,!0),t=e.input.charCodeAt(++e.position),t===39)r=e.position,e.position++,i=e.position;else return!0;else M(t)?(q(e,r,i,!0),yt(e,S(e,!1,n)),r=i=e.position):e.position===e.lineStart&&Oe(e)?v(e,"unexpected end of the document within a single quoted scalar"):(e.position++,i=e.position);v(e,"unexpected end of the stream within a single quoted scalar")}function gi(e,n){var t,r,i,s,o,a;if(a=e.input.charCodeAt(e.position),a!==34)return!1;for(e.kind="scalar",e.result="",e.position++,t=r=e.position;(a=e.input.charCodeAt(e.position))!==0;){if(a===34)return q(e,t,e.position,!0),e.position++,!0;if(a===92){if(q(e,t,e.position,!0),a=e.input.charCodeAt(++e.position),M(a))S(e,!1,n);else if(a<256&&er[a])e.result+=tr[a],e.position++;else if((o=ci(a))>0){for(i=o,s=0;i>0;i--)a=e.input.charCodeAt(++e.position),(o=li(a))>=0?s=(s<<4)+o:v(e,"expected hexadecimal character");e.result+=pi(s),e.position++}else v(e,"unknown escape sequence");t=r=e.position}else M(a)?(q(e,t,r,!0),yt(e,S(e,!1,n)),t=r=e.position):e.position===e.lineStart&&Oe(e)?v(e,"unexpected end of the document within a double quoted scalar"):(e.position++,r=e.position)}v(e,"unexpected end of the stream within a double quoted scalar")}function mi(e,n){var t=!0,r,i,s,o=e.tag,a,l=e.anchor,c,d,p,u,h,x=Object.create(null),g,m,b,f;if(f=e.input.charCodeAt(e.position),f===91)d=93,h=!1,a=[];else if(f===123)d=125,h=!0,a={};else return!1;for(e.anchor!==null&&(e.anchorMap[e.anchor]=a),f=e.input.charCodeAt(++e.position);f!==0;){if(S(e,!0,n),f=e.input.charCodeAt(e.position),f===d)return e.position++,e.tag=o,e.anchor=l,e.kind=h?"mapping":"sequence",e.result=a,!0;t?f===44&&v(e,"expected the node content, but found ','"):v(e,"missed comma between flow collection entries"),m=g=b=null,p=u=!1,f===63&&(c=e.input.charCodeAt(e.position+1),N(c)&&(p=u=!0,e.position++,S(e,!0,n))),r=e.line,i=e.lineStart,s=e.position,ae(e,n,Re,!1,!0),m=e.tag,g=e.result,S(e,!0,n),f=e.input.charCodeAt(e.position),(u||e.line===r)&&f===58&&(p=!0,f=e.input.charCodeAt(++e.position),S(e,!0,n),ae(e,n,Re,!1,!0),b=e.result),h?se(e,a,x,m,g,b,r,i,s):p?a.push(se(e,null,x,m,g,b,r,i,s)):a.push(g),S(e,!0,n),f=e.input.charCodeAt(e.position),f===44?(t=!0,f=e.input.charCodeAt(++e.position)):t=!1}v(e,"unexpected end of the stream within a flow collection")}function xi(e,n){var t,r,i=dt,s=!1,o=!1,a=n,l=0,c=!1,d,p;if(p=e.input.charCodeAt(e.position),p===124)r=!1;else if(p===62)r=!0;else return!1;for(e.kind="scalar",e.result="";p!==0;)if(p=e.input.charCodeAt(++e.position),p===43||p===45)dt===i?i=p===43?Dt:ii:v(e,"repeat of a chomping mode identifier");else if((d=di(p))>=0)d===0?v(e,"bad explicit indentation width of a block scalar; it cannot be less than one"):o?v(e,"repeat of an indentation width identifier"):(a=n+d-1,o=!0);else break;if(X(p)){do p=e.input.charCodeAt(++e.position);while(X(p));if(p===35)do p=e.input.charCodeAt(++e.position);while(!M(p)&&p!==0)}for(;p!==0;){for(bt(e),e.lineIndent=0,p=e.input.charCodeAt(e.position);(!o||e.lineIndent<a)&&p===32;)e.lineIndent++,p=e.input.charCodeAt(++e.position);if(!o&&e.lineIndent>a&&(a=e.lineIndent),M(p)){l++;continue}if(e.lineIndent<a){i===Dt?e.result+=A.repeat(`
`,s?1+l:l):i===dt&&s&&(e.result+=`
`);break}for(r?X(p)?(c=!0,e.result+=A.repeat(`
`,s?1+l:l)):c?(c=!1,e.result+=A.repeat(`
`,l+1)):l===0?s&&(e.result+=" "):e.result+=A.repeat(`
`,l):e.result+=A.repeat(`
`,s?1+l:l),s=!0,o=!0,l=0,t=e.position;!M(p)&&p!==0;)p=e.input.charCodeAt(++e.position);q(e,t,e.position,!1)}return!0}function It(e,n){var t,r=e.tag,i=e.anchor,s=[],o,a=!1,l;if(e.firstTabInLine!==-1)return!1;for(e.anchor!==null&&(e.anchorMap[e.anchor]=s),l=e.input.charCodeAt(e.position);l!==0&&(e.firstTabInLine!==-1&&(e.position=e.firstTabInLine,v(e,"tab characters must not be used in indentation")),!(l!==45||(o=e.input.charCodeAt(e.position+1),!N(o))));){if(a=!0,e.position++,S(e,!0,-1)&&e.lineIndent<=n){s.push(null),l=e.input.charCodeAt(e.position);continue}if(t=e.line,ae(e,n,Jt,!1,!0),s.push(e.result),S(e,!0,-1),l=e.input.charCodeAt(e.position),(e.line===t||e.lineIndent>n)&&l!==0)v(e,"bad indentation of a sequence entry");else if(e.lineIndent<n)break}return a?(e.tag=r,e.anchor=i,e.kind="sequence",e.result=s,!0):!1}function bi(e,n,t){var r,i,s,o,a,l,c=e.tag,d=e.anchor,p={},u=Object.create(null),h=null,x=null,g=null,m=!1,b=!1,f;if(e.firstTabInLine!==-1)return!1;for(e.anchor!==null&&(e.anchorMap[e.anchor]=p),f=e.input.charCodeAt(e.position);f!==0;){if(!m&&e.firstTabInLine!==-1&&(e.position=e.firstTabInLine,v(e,"tab characters must not be used in indentation")),r=e.input.charCodeAt(e.position+1),s=e.line,(f===63||f===58)&&N(r))f===63?(m&&(se(e,p,u,h,x,null,o,a,l),h=x=g=null),b=!0,m=!0,i=!0):m?(m=!1,i=!0):v(e,"incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line"),e.position+=1,f=r;else{if(o=e.line,a=e.lineStart,l=e.position,!ae(e,t,Kt,!1,!0))break;if(e.line===s){for(f=e.input.charCodeAt(e.position);X(f);)f=e.input.charCodeAt(++e.position);if(f===58)f=e.input.charCodeAt(++e.position),N(f)||v(e,"a whitespace character is expected after the key-value separator within a block mapping"),m&&(se(e,p,u,h,x,null,o,a,l),h=x=g=null),b=!0,m=!1,i=!1,h=e.tag,x=e.result;else if(b)v(e,"can not read an implicit mapping pair; a colon is missed");else return e.tag=c,e.anchor=d,!0}else if(b)v(e,"can not read a block mapping entry; a multiline key may not be an implicit key");else return e.tag=c,e.anchor=d,!0}if((e.line===s||e.lineIndent>n)&&(m&&(o=e.line,a=e.lineStart,l=e.position),ae(e,n,_e,!0,i)&&(m?x=e.result:g=e.result),m||(se(e,p,u,h,x,g,o,a,l),h=x=g=null),S(e,!0,-1),f=e.input.charCodeAt(e.position)),(e.line===s||e.lineIndent>n)&&f!==0)v(e,"bad indentation of a mapping entry");else if(e.lineIndent<n)break}return m&&se(e,p,u,h,x,null,o,a,l),b&&(e.tag=c,e.anchor=d,e.kind="mapping",e.result=p),b}function yi(e){var n,t=!1,r=!1,i,s,o;if(o=e.input.charCodeAt(e.position),o!==33)return!1;if(e.tag!==null&&v(e,"duplication of a tag property"),o=e.input.charCodeAt(++e.position),o===60?(t=!0,o=e.input.charCodeAt(++e.position)):o===33?(r=!0,i="!!",o=e.input.charCodeAt(++e.position)):i="!",n=e.position,t){do o=e.input.charCodeAt(++e.position);while(o!==0&&o!==62);e.position<e.length?(s=e.input.slice(n,e.position),o=e.input.charCodeAt(++e.position)):v(e,"unexpected end of the stream within a verbatim tag")}else{for(;o!==0&&!N(o);)o===33&&(r?v(e,"tag suffix cannot contain exclamation marks"):(i=e.input.slice(n-1,e.position+1),Qt.test(i)||v(e,"named tag handle cannot contain such characters"),r=!0,n=e.position+1)),o=e.input.charCodeAt(++e.position);s=e.input.slice(n,e.position),ai.test(s)&&v(e,"tag suffix cannot contain flow indicator characters")}s&&!Zt.test(s)&&v(e,"tag name cannot contain such characters: "+s);try{s=decodeURIComponent(s)}catch(a){v(e,"tag name is malformed: "+s)}return t?e.tag=s:W.call(e.tagMap,i)?e.tag=e.tagMap[i]+s:i==="!"?e.tag="!"+s:i==="!!"?e.tag="tag:yaml.org,2002:"+s:v(e,'undeclared tag handle "'+i+'"'),!0}function vi(e){var n,t;if(t=e.input.charCodeAt(e.position),t!==38)return!1;for(e.anchor!==null&&v(e,"duplication of an anchor property"),t=e.input.charCodeAt(++e.position),n=e.position;t!==0&&!N(t)&&!oe(t);)t=e.input.charCodeAt(++e.position);return e.position===n&&v(e,"name of an anchor node must contain at least one character"),e.anchor=e.input.slice(n,e.position),!0}function ki(e){var n,t,r;if(r=e.input.charCodeAt(e.position),r!==42)return!1;for(r=e.input.charCodeAt(++e.position),n=e.position;r!==0&&!N(r)&&!oe(r);)r=e.input.charCodeAt(++e.position);return e.position===n&&v(e,"name of an alias node must contain at least one character"),t=e.input.slice(n,e.position),W.call(e.anchorMap,t)||v(e,'unidentified alias "'+t+'"'),e.result=e.anchorMap[t],S(e,!0,-1),!0}function ae(e,n,t,r,i){var s,o,a,l=1,c=!1,d=!1,p,u,h,x,g,m;if(e.listener!==null&&e.listener("open",e),e.tag=null,e.anchor=null,e.kind=null,e.result=null,s=o=a=_e===t||Jt===t,r&&S(e,!0,-1)&&(c=!0,e.lineIndent>n?l=1:e.lineIndent===n?l=0:e.lineIndent<n&&(l=-1)),l===1)for(;yi(e)||vi(e);)S(e,!0,-1)?(c=!0,a=s,e.lineIndent>n?l=1:e.lineIndent===n?l=0:e.lineIndent<n&&(l=-1)):a=!1;if(a&&(a=c||i),(l===1||_e===t)&&(Re===t||Kt===t?g=n:g=n+1,m=e.position-e.lineStart,l===1?a&&(It(e,m)||bi(e,m,g))||mi(e,g)?d=!0:(o&&xi(e,g)||fi(e,g)||gi(e,g)?d=!0:ki(e)?(d=!0,(e.tag!==null||e.anchor!==null)&&v(e,"alias node should not have any properties")):hi(e,g,Re===t)&&(d=!0,e.tag===null&&(e.tag="?")),e.anchor!==null&&(e.anchorMap[e.anchor]=e.result)):l===0&&(d=a&&It(e,m))),e.tag===null)e.anchor!==null&&(e.anchorMap[e.anchor]=e.result);else if(e.tag==="?"){for(e.result!==null&&e.kind!=="scalar"&&v(e,'unacceptable node kind for !<?> tag; it should be "scalar", not "'+e.kind+'"'),p=0,u=e.implicitTypes.length;p<u;p+=1)if(x=e.implicitTypes[p],x.resolve(e.result)){e.result=x.construct(e.result),e.tag=x.tag,e.anchor!==null&&(e.anchorMap[e.anchor]=e.result);break}}else if(e.tag!=="!"){if(W.call(e.typeMap[e.kind||"fallback"],e.tag))x=e.typeMap[e.kind||"fallback"][e.tag];else for(x=null,h=e.typeMap.multi[e.kind||"fallback"],p=0,u=h.length;p<u;p+=1)if(e.tag.slice(0,h[p].tag.length)===h[p].tag){x=h[p];break}x||v(e,"unknown tag !<"+e.tag+">"),e.result!==null&&x.kind!==e.kind&&v(e,"unacceptable node kind for !<"+e.tag+'> tag; it should be "'+x.kind+'", not "'+e.kind+'"'),x.resolve(e.result,e.tag)?(e.result=x.construct(e.result,e.tag),e.anchor!==null&&(e.anchorMap[e.anchor]=e.result)):v(e,"cannot resolve a node with !<"+e.tag+"> explicit tag")}return e.listener!==null&&e.listener("close",e),e.tag!==null||e.anchor!==null||d}function Ei(e){var n=e.position,t,r,i,s=!1,o;for(e.version=null,e.checkLineBreaks=e.legacy,e.tagMap=Object.create(null),e.anchorMap=Object.create(null);(o=e.input.charCodeAt(e.position))!==0&&(S(e,!0,-1),o=e.input.charCodeAt(e.position),!(e.lineIndent>0||o!==37));){for(s=!0,o=e.input.charCodeAt(++e.position),t=e.position;o!==0&&!N(o);)o=e.input.charCodeAt(++e.position);for(r=e.input.slice(t,e.position),i=[],r.length<1&&v(e,"directive name must not be less than one character in length");o!==0;){for(;X(o);)o=e.input.charCodeAt(++e.position);if(o===35){do o=e.input.charCodeAt(++e.position);while(o!==0&&!M(o));break}if(M(o))break;for(t=e.position;o!==0&&!N(o);)o=e.input.charCodeAt(++e.position);i.push(e.input.slice(t,e.position))}o!==0&&bt(e),W.call(_t,r)?_t[r](e,r,i):Ne(e,'unknown document directive "'+r+'"')}if(S(e,!0,-1),e.lineIndent===0&&e.input.charCodeAt(e.position)===45&&e.input.charCodeAt(e.position+1)===45&&e.input.charCodeAt(e.position+2)===45?(e.position+=3,S(e,!0,-1)):s&&v(e,"directives end mark is expected"),ae(e,e.lineIndent-1,_e,!1,!0),S(e,!0,-1),e.checkLineBreaks&&si.test(e.input.slice(n,e.position))&&Ne(e,"non-ASCII line breaks are interpreted as content"),e.documents.push(e.result),e.position===e.lineStart&&Oe(e)){e.input.charCodeAt(e.position)===46&&(e.position+=3,S(e,!0,-1));return}if(e.position<e.length-1)v(e,"end of the stream or a document separator is expected");else return}function nr(e,n){e=String(e),n=n||{},e.length!==0&&(e.charCodeAt(e.length-1)!==10&&e.charCodeAt(e.length-1)!==13&&(e+=`
`),e.charCodeAt(0)===65279&&(e=e.slice(1)));var t=new ui(e,n),r=e.indexOf("\0");for(r!==-1&&(t.position=r,v(t,"null byte is not allowed in input")),t.input+="\0";t.input.charCodeAt(t.position)===32;)t.lineIndent+=1,t.position+=1;for(;t.position<t.length-1;)Ei(t);return t.documents}function wi(e,n,t){n!==null&&typeof n=="object"&&typeof t=="undefined"&&(t=n,n=null);var r=nr(e,t);if(typeof n!="function")return r;for(var i=0,s=r.length;i<s;i+=1)n(r[i])}function Ci(e,n){var t=nr(e,n);if(t.length!==0){if(t.length===1)return t[0];throw new _("expected a single document in the stream, but found more")}}function Vi(e,n){var t,r,i,s,o,a,l;if(n===null)return{};for(t={},r=Object.keys(n),i=0,s=r.length;i<s;i+=1)o=r[i],a=String(n[o]),o.slice(0,2)==="!!"&&(o="tag:yaml.org,2002:"+o.slice(2)),l=e.compiledTypeMap.fallback[o],l&&sr.call(l.styleAliases,a)&&(a=l.styleAliases[a]),t[o]=a;return t}function qi(e){var n,t,r;if(n=e.toString(16).toUpperCase(),e<=255)t="x",r=2;else if(e<=65535)t="u",r=4;else if(e<=4294967295)t="U",r=8;else throw new _("code point within a string may not be greater than 0xFFFFFFFF");return"\\"+t+A.repeat("0",r-n.length)+n}function Gi(e){this.schema=e.schema||xt,this.indent=Math.max(1,e.indent||2),this.noArrayIndent=e.noArrayIndent||!1,this.skipInvalid=e.skipInvalid||!1,this.flowLevel=A.isNothing(e.flowLevel)?-1:e.flowLevel,this.styleMap=Vi(this.schema,e.styles||null),this.sortKeys=e.sortKeys||!1,this.lineWidth=e.lineWidth||80,this.noRefs=e.noRefs||!1,this.noCompatMode=e.noCompatMode||!1,this.condenseFlow=e.condenseFlow||!1,this.quotingType=e.quotingType==='"'?be:Wi,this.forceQuotes=e.forceQuotes||!1,this.replacer=typeof e.replacer=="function"?e.replacer:null,this.implicitTypes=this.schema.compiledImplicit,this.explicitTypes=this.schema.compiledExplicit,this.tag=null,this.result="",this.duplicates=[],this.usedDuplicates=null}function Mt(e,n){for(var t=A.repeat(" ",n),r=0,i=-1,s="",o,a=e.length;r<a;)i=e.indexOf(`
`,r),i===-1?(o=e.slice(r),r=a):(o=e.slice(r,i+1),r=i+1),o.length&&o!==`
`&&(s+=t),s+=o;return s}function ht(e,n){return`
`+A.repeat(" ",e.indent*n)}function Ki(e,n){var t,r,i;for(t=0,r=e.implicitTypes.length;t<r;t+=1)if(i=e.implicitTypes[t],i.resolve(n))return!0;return!1}function Me(e){return e===Pi||e===Ai}function ye(e){return 32<=e&&e<=126||161<=e&&e<=55295&&e!==8232&&e!==8233||57344<=e&&e<=65533&&e!==vt||65536<=e&&e<=1114111}function Ot(e){return ye(e)&&e!==vt&&e!==Bi&&e!==xe}function $t(e,n,t){var r=Ot(e),i=r&&!Me(e);return(t?r:r&&e!==ar&&e!==lr&&e!==cr&&e!==dr&&e!==pr)&&e!==ut&&!(n===Ie&&!i)||Ot(n)&&!Me(n)&&e===ut||n===Ie&&i}function Ji(e){return ye(e)&&e!==vt&&!Me(e)&&e!==Ii&&e!==$i&&e!==Ie&&e!==ar&&e!==lr&&e!==cr&&e!==dr&&e!==pr&&e!==ut&&e!==Ri&&e!==Ni&&e!==Fi&&e!==zi&&e!==Mi&&e!==Oi&&e!==_i&&e!==Di&&e!==Li&&e!==Hi&&e!==Ui}function Qi(e){return!Me(e)&&e!==Ie}function ge(e,n){var t=e.charCodeAt(n),r;return t>=55296&&t<=56319&&n+1<e.length&&(r=e.charCodeAt(n+1),r>=56320&&r<=57343)?(t-55296)*1024+r-56320+65536:t}function ur(e){var n=/^\n* /;return n.test(e)}function Zi(e,n,t,r,i,s,o,a){var l,c=0,d=null,p=!1,u=!1,h=r!==-1,x=-1,g=Ji(ge(e,0))&&Qi(ge(e,e.length-1));if(n||o)for(l=0;l<e.length;c>=65536?l+=2:l++){if(c=ge(e,l),!ye(c))return ie;g=g&&$t(c,d,a),d=c}else{for(l=0;l<e.length;c>=65536?l+=2:l++){if(c=ge(e,l),c===xe)p=!0,h&&(u=u||l-x-1>r&&e[x+1]!==" ",x=l);else if(!ye(c))return ie;g=g&&$t(c,d,a),d=c}u=u||h&&l-x-1>r&&e[x+1]!==" "}return!p&&!u?g&&!o&&!i(e)?hr:s===be?ie:ft:t>9&&ur(e)?ie:o?s===be?ie:ft:u?gr:fr}function Xi(e,n,t,r,i){e.dump=function(){if(n.length===0)return e.quotingType===be?'""':"''";if(!e.noCompatMode&&(ji.indexOf(n)!==-1||Yi.test(n)))return e.quotingType===be?'"'+n+'"':"'"+n+"'";var s=e.indent*Math.max(1,t),o=e.lineWidth===-1?-1:Math.max(Math.min(e.lineWidth,40),e.lineWidth-s),a=r||e.flowLevel>-1&&t>=e.flowLevel;function l(c){return Ki(e,c)}switch(Zi(n,a,e.indent,o,l,e.quotingType,e.forceQuotes&&!r,i)){case hr:return n;case ft:return"'"+n.replace(/'/g,"''")+"'";case fr:return"|"+Ht(n,e.indent)+Ut(Mt(n,s));case gr:return">"+Ht(n,e.indent)+Ut(Mt(eo(n,o),s));case ie:return'"'+to(n)+'"';default:throw new _("impossible error: invalid scalar style")}}()}function Ht(e,n){var t=ur(e)?String(n):"",r=e[e.length-1]===`
`,i=r&&(e[e.length-2]===`
`||e===`
`),s=i?"+":r?"":"-";return t+s+`
`}function Ut(e){return e[e.length-1]===`
`?e.slice(0,-1):e}function eo(e,n){for(var t=/(\n+)([^\n]*)/g,r=function(){var c=e.indexOf(`
`);return c=c!==-1?c:e.length,t.lastIndex=c,zt(e.slice(0,c),n)}(),i=e[0]===`
`||e[0]===" ",s,o;o=t.exec(e);){var a=o[1],l=o[2];s=l[0]===" ",r+=a+(!i&&!s&&l!==""?`
`:"")+zt(l,n),i=s}return r}function zt(e,n){if(e===""||e[0]===" ")return e;for(var t=/ [^ ]/g,r,i=0,s,o=0,a=0,l="";r=t.exec(e);)a=r.index,a-i>n&&(s=o>i?o:a,l+=`
`+e.slice(i,s),i=s+1),o=a;return l+=`
`,e.length-i>n&&o>i?l+=e.slice(i,o)+`
`+e.slice(o+1):l+=e.slice(i),l.slice(1)}function to(e){for(var n="",t=0,r,i=0;i<e.length;t>=65536?i+=2:i++)t=ge(e,i),r=F[t],!r&&ye(t)?(n+=e[i],t>=65536&&(n+=e[i+1])):n+=r||qi(t);return n}function ro(e,n,t){var r="",i=e.tag,s,o,a;for(s=0,o=t.length;s<o;s+=1)a=t[s],e.replacer&&(a=e.replacer.call(t,String(s),a)),(j(e,n,a,!1,!1)||typeof a=="undefined"&&j(e,n,null,!1,!1))&&(r!==""&&(r+=","+(e.condenseFlow?"":" ")),r+=e.dump);e.tag=i,e.dump="["+r+"]"}function jt(e,n,t,r){var i="",s=e.tag,o,a,l;for(o=0,a=t.length;o<a;o+=1)l=t[o],e.replacer&&(l=e.replacer.call(t,String(o),l)),(j(e,n+1,l,!0,!0,!1,!0)||typeof l=="undefined"&&j(e,n+1,null,!0,!0,!1,!0))&&((!r||i!=="")&&(i+=ht(e,n)),e.dump&&xe===e.dump.charCodeAt(0)?i+="-":i+="- ",i+=e.dump);e.tag=s,e.dump=i||"[]"}function no(e,n,t){var r="",i=e.tag,s=Object.keys(t),o,a,l,c,d;for(o=0,a=s.length;o<a;o+=1)d="",r!==""&&(d+=", "),e.condenseFlow&&(d+='"'),l=s[o],c=t[l],e.replacer&&(c=e.replacer.call(t,l,c)),j(e,n,l,!1,!1)&&(e.dump.length>1024&&(d+="? "),d+=e.dump+(e.condenseFlow?'"':"")+":"+(e.condenseFlow?"":" "),j(e,n,c,!1,!1)&&(d+=e.dump,r+=d));e.tag=i,e.dump="{"+r+"}"}function io(e,n,t,r){var i="",s=e.tag,o=Object.keys(t),a,l,c,d,p,u;if(e.sortKeys===!0)o.sort();else if(typeof e.sortKeys=="function")o.sort(e.sortKeys);else if(e.sortKeys)throw new _("sortKeys must be a boolean or a function");for(a=0,l=o.length;a<l;a+=1)u="",(!r||i!=="")&&(u+=ht(e,n)),c=o[a],d=t[c],e.replacer&&(d=e.replacer.call(t,c,d)),j(e,n+1,c,!0,!0,!0)&&(p=e.tag!==null&&e.tag!=="?"||e.dump&&e.dump.length>1024,p&&(e.dump&&xe===e.dump.charCodeAt(0)?u+="?":u+="? "),u+=e.dump,p&&(u+=ht(e,n)),j(e,n+1,d,!0,p)&&(e.dump&&xe===e.dump.charCodeAt(0)?u+=":":u+=": ",u+=e.dump,i+=u));e.tag=s,e.dump=i||"{}"}function Yt(e,n,t){var r,i,s,o,a,l;for(i=t?e.explicitTypes:e.implicitTypes,s=0,o=i.length;s<o;s+=1)if(a=i[s],(a.instanceOf||a.predicate)&&(!a.instanceOf||typeof n=="object"&&n instanceof a.instanceOf)&&(!a.predicate||a.predicate(n))){if(t?a.multi&&a.representName?e.tag=a.representName(n):e.tag=a.tag:e.tag="?",a.represent){if(l=e.styleMap[a.tag]||a.defaultStyle,or.call(a.represent)==="[object Function]")r=a.represent(n,l);else if(sr.call(a.represent,l))r=a.represent[l](n,l);else throw new _("!<"+a.tag+'> tag resolver accepts not "'+l+'" style');e.dump=r}return!0}return!1}function j(e,n,t,r,i,s,o){e.tag=null,e.dump=t,Yt(e,t,!1)||Yt(e,t,!0);var a=or.call(e.dump),l=r,c;r&&(r=e.flowLevel<0||e.flowLevel>n);var d=a==="[object Object]"||a==="[object Array]",p,u;if(d&&(p=e.duplicates.indexOf(t),u=p!==-1),(e.tag!==null&&e.tag!=="?"||u||e.indent!==2&&n>0)&&(i=!1),u&&e.usedDuplicates[p])e.dump="*ref_"+p;else{if(d&&u&&!e.usedDuplicates[p]&&(e.usedDuplicates[p]=!0),a==="[object Object]")r&&Object.keys(e.dump).length!==0?(io(e,n,e.dump,i),u&&(e.dump="&ref_"+p+e.dump)):(no(e,n,e.dump),u&&(e.dump="&ref_"+p+" "+e.dump));else if(a==="[object Array]")r&&e.dump.length!==0?(e.noArrayIndent&&!o&&n>0?jt(e,n-1,e.dump,i):jt(e,n,e.dump,i),u&&(e.dump="&ref_"+p+e.dump)):(ro(e,n,e.dump),u&&(e.dump="&ref_"+p+" "+e.dump));else if(a==="[object String]")e.tag!=="?"&&Xi(e,e.dump,n,s,l);else{if(a==="[object Undefined]")return!1;if(e.skipInvalid)return!1;throw new _("unacceptable kind of an object to dump "+a)}e.tag!==null&&e.tag!=="?"&&(c=encodeURI(e.tag[0]==="!"?e.tag.slice(1):e.tag).replace(/!/g,"%21"),e.tag[0]==="!"?c="!"+c:c.slice(0,18)==="tag:yaml.org,2002:"?c="!!"+c.slice(18):c="!<"+c+">",e.dump=c+" "+e.dump)}return!0}function oo(e,n){var t=[],r=[],i,s;for(gt(e,t,r),i=0,s=r.length;i<s;i+=1)n.duplicates.push(t[r[i]]);n.usedDuplicates=new Array(s)}function gt(e,n,t){var r,i,s;if(e!==null&&typeof e=="object")if(i=n.indexOf(e),i!==-1)t.indexOf(i)===-1&&t.push(i);else if(n.push(e),Array.isArray(e))for(i=0,s=e.length;i<s;i+=1)gt(e[i],n,t);else for(r=Object.keys(e),i=0,s=r.length;i<s;i+=1)gt(e[r[i]],n,t)}function so(e,n){n=n||{};var t=new Gi(n);t.noRefs||oo(e,t);var r=e;return t.replacer&&(r=t.replacer.call({"":r},"",r)),j(t,0,r,!0,!0)?t.dump+`
`:""}function kt(e,n){return function(){throw new Error("Function yaml."+e+" is removed in js-yaml 4. Use yaml."+n+" instead, which is now safe by default.")}}var Vr,qr,Wr,Gr,Kr,Jr,A,_,Zr,Xr,en,P,on,sn,an,ln,cn,hn,xn,Cn,Tn,Bn,Dn,Ln,Rn,Wt,Gt,Mn,$n,mt,Yn,Vn,qn,Kn,Jn,Xn,ei,ni,xt,W,Re,Kt,Jt,_e,dt,ii,Dt,oi,si,ai,Qt,Zt,er,tr,Z,_t,Ti,Si,ir,or,sr,vt,Ai,xe,Bi,Pi,Fi,Di,ut,Li,Ri,_i,Ni,ar,Ii,Ie,Mi,Oi,$i,Hi,lr,cr,Ui,dr,zi,pr,F,ji,Yi,Wi,be,hr,ft,fr,gr,ie,ao,lo,mr,xr,Ao,br,Bo,Po,Fo,Et=B(()=>{Vr=Vt,qr=Hr,Wr=Ur,Gr=jr,Kr=Yr,Jr=zr,A={isNothing:Vr,isObject:qr,toArray:Wr,repeat:Gr,isNegativeZero:Kr,extend:Jr};me.prototype=Object.create(Error.prototype);me.prototype.constructor=me;me.prototype.toString=function(n){return this.name+": "+qt(this,n)};_=me;Zr=Qr,Xr=["kind","multi","resolve","construct","instanceOf","predicate","represent","representName","defaultStyle","styleAliases"],en=["scalar","sequence","mapping"];P=rn;pt.prototype.extend=function(n){var t=[],r=[];if(n instanceof P)r.push(n);else if(Array.isArray(n))r=r.concat(n);else if(n&&(Array.isArray(n.implicit)||Array.isArray(n.explicit)))n.implicit&&(t=t.concat(n.implicit)),n.explicit&&(r=r.concat(n.explicit));else throw new _("Schema.extend argument should be a Type, [ Type ], or a schema definition ({ implicit: [...], explicit: [...] })");t.forEach(function(s){if(!(s instanceof P))throw new _("Specified list of YAML types (or a single Type object) contains a non-Type object.");if(s.loadKind&&s.loadKind!=="scalar")throw new _("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");if(s.multi)throw new _("There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.")}),r.forEach(function(s){if(!(s instanceof P))throw new _("Specified list of YAML types (or a single Type object) contains a non-Type object.")});var i=Object.create(pt.prototype);return i.implicit=(this.implicit||[]).concat(t),i.explicit=(this.explicit||[]).concat(r),i.compiledImplicit=Ft(i,"implicit"),i.compiledExplicit=Ft(i,"explicit"),i.compiledTypeMap=nn(i.compiledImplicit,i.compiledExplicit),i};on=pt,sn=new P("tag:yaml.org,2002:str",{kind:"scalar",construct:function(e){return e!==null?e:""}}),an=new P("tag:yaml.org,2002:seq",{kind:"sequence",construct:function(e){return e!==null?e:[]}}),ln=new P("tag:yaml.org,2002:map",{kind:"mapping",construct:function(e){return e!==null?e:{}}}),cn=new on({explicit:[sn,an,ln]});hn=new P("tag:yaml.org,2002:null",{kind:"scalar",resolve:dn,construct:pn,predicate:un,represent:{canonical:function(){return"~"},lowercase:function(){return"null"},uppercase:function(){return"NULL"},camelcase:function(){return"Null"},empty:function(){return""}},defaultStyle:"lowercase"});xn=new P("tag:yaml.org,2002:bool",{kind:"scalar",resolve:fn,construct:gn,predicate:mn,represent:{lowercase:function(e){return e?"true":"false"},uppercase:function(e){return e?"TRUE":"FALSE"},camelcase:function(e){return e?"True":"False"}},defaultStyle:"lowercase"});Cn=new P("tag:yaml.org,2002:int",{kind:"scalar",resolve:kn,construct:En,predicate:wn,represent:{binary:function(e){return e>=0?"0b"+e.toString(2):"-0b"+e.toString(2).slice(1)},octal:function(e){return e>=0?"0o"+e.toString(8):"-0o"+e.toString(8).slice(1)},decimal:function(e){return e.toString(10)},hexadecimal:function(e){return e>=0?"0x"+e.toString(16).toUpperCase():"-0x"+e.toString(16).toUpperCase().slice(1)}},defaultStyle:"decimal",styleAliases:{binary:[2,"bin"],octal:[8,"oct"],decimal:[10,"dec"],hexadecimal:[16,"hex"]}}),Tn=new RegExp("^(?:[-+]?(?:[0-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$");Bn=/^[-+]?[0-9]+e/;Dn=new P("tag:yaml.org,2002:float",{kind:"scalar",resolve:Sn,construct:An,predicate:Fn,represent:Pn,defaultStyle:"lowercase"}),Ln=cn.extend({implicit:[hn,xn,Cn,Dn]}),Rn=Ln,Wt=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),Gt=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$");Mn=new P("tag:yaml.org,2002:timestamp",{kind:"scalar",resolve:_n,construct:Nn,instanceOf:Date,represent:In});$n=new P("tag:yaml.org,2002:merge",{kind:"scalar",resolve:On}),mt=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=
\r`;Yn=new P("tag:yaml.org,2002:binary",{kind:"scalar",resolve:Hn,construct:Un,predicate:jn,represent:zn}),Vn=Object.prototype.hasOwnProperty,qn=Object.prototype.toString;Kn=new P("tag:yaml.org,2002:omap",{kind:"sequence",resolve:Wn,construct:Gn}),Jn=Object.prototype.toString;Xn=new P("tag:yaml.org,2002:pairs",{kind:"sequence",resolve:Qn,construct:Zn}),ei=Object.prototype.hasOwnProperty;ni=new P("tag:yaml.org,2002:set",{kind:"mapping",resolve:ti,construct:ri}),xt=Rn.extend({implicit:[Mn,$n],explicit:[Yn,Kn,Xn,ni]}),W=Object.prototype.hasOwnProperty,Re=1,Kt=2,Jt=3,_e=4,dt=1,ii=2,Dt=3,oi=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,si=/[\x85\u2028\u2029]/,ai=/[,\[\]\{\}]/,Qt=/^(?:!|!!|![a-z\-]+!)$/i,Zt=/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&=\+\$,_\.!~\*'\(\)\[\]])*$/i;er=new Array(256),tr=new Array(256);for(Z=0;Z<256;Z++)er[Z]=Rt(Z)?1:0,tr[Z]=Rt(Z);_t={YAML:function(n,t,r){var i,s,o;n.version!==null&&v(n,"duplication of %YAML directive"),r.length!==1&&v(n,"YAML directive accepts exactly one argument"),i=/^([0-9]+)\.([0-9]+)$/.exec(r[0]),i===null&&v(n,"ill-formed argument of the YAML directive"),s=parseInt(i[1],10),o=parseInt(i[2],10),s!==1&&v(n,"unacceptable YAML version of the document"),n.version=r[0],n.checkLineBreaks=o<2,o!==1&&o!==2&&Ne(n,"unsupported YAML version of the document")},TAG:function(n,t,r){var i,s;r.length!==2&&v(n,"TAG directive accepts exactly two arguments"),i=r[0],s=r[1],Qt.test(i)||v(n,"ill-formed tag handle (first argument) of the TAG directive"),W.call(n.tagMap,i)&&v(n,'there is a previously declared suffix for "'+i+'" tag handle'),Zt.test(s)||v(n,"ill-formed tag prefix (second argument) of the TAG directive");try{s=decodeURIComponent(s)}catch(o){v(n,"tag prefix is malformed: "+s)}n.tagMap[i]=s}};Ti=wi,Si=Ci,ir={loadAll:Ti,load:Si},or=Object.prototype.toString,sr=Object.prototype.hasOwnProperty,vt=65279,Ai=9,xe=10,Bi=13,Pi=32,Fi=33,Di=34,ut=35,Li=37,Ri=38,_i=39,Ni=42,ar=44,Ii=45,Ie=58,Mi=61,Oi=62,$i=63,Hi=64,lr=91,cr=93,Ui=96,dr=123,zi=124,pr=125,F={};F[0]="\\0";F[7]="\\a";F[8]="\\b";F[9]="\\t";F[10]="\\n";F[11]="\\v";F[12]="\\f";F[13]="\\r";F[27]="\\e";F[34]='\\"';F[92]="\\\\";F[133]="\\N";F[160]="\\_";F[8232]="\\L";F[8233]="\\P";ji=["y","Y","yes","Yes","YES","on","On","ON","n","N","no","No","NO","off","Off","OFF"],Yi=/^[-+]?[0-9_]+(?::[0-9_]+)+(?:\.[0-9_]*)?$/;Wi=1,be=2;hr=1,ft=2,fr=3,gr=4,ie=5;ao=so,lo={dump:ao};mr=xt,xr=ir.load,Ao=ir.loadAll,br=lo.dump,Bo=kt("safeLoad","load"),Po=kt("safeLoadAll","loadAll"),Fo=kt("safeDump","dump")});var Y,$e=B(()=>{Et();Y=class{static create(n){let t={};for(let[r,i]of Object.entries(n))if(i!=null&&r!=="reading_history"){if(i===""){(r==="title"||r==="author"||r==="status")&&(t[r]=i);continue}if(Array.isArray(i)){if(i.length===0){r==="reading_history_summary"&&(t[r]=[]);continue}if(r==="reading_history_summary"){let s=i.filter(o=>o&&typeof o=="object"&&!Array.isArray(o));t[r]=s.length>0?s:[]}else t[r]=i}else t[r]=i}try{return`---
${br(t,{lineWidth:-1,noRefs:!0,quotingType:'"',forceQuotes:!1,indent:2})}---`}catch(r){return console.error("[FrontmatterCreator] Error creating YAML:",r),`---
---`}}}});var He,vr=B(()=>{Q();He=class{processTemplate(n,t){let r=this.prepareTemplateData(t);return this.replacePlaceholders(n,r)}getDefaultTemplate(){return this.getDefaultTemplateContent()}prepareTemplateData(n){var t,r;return{title:n.title||"",subtitle:n.subtitle||"",author:this.formatAuthorArray(n.author||[]),category:this.formatArray(n.category||[]),publisher:n.publisher||"",publishDate:n.publishDate||"",totalPage:((t=n.totalPages)==null?void 0:t.toString())||"",isbn10:n.isbn10||"",isbn13:n.isbn13||"",coverUrl:n.coverUrl||"",page:((r=n.readPage)==null?void 0:r.toString())||"0"}}formatAuthorArray(n){return n.length===0?"":n.map(t=>`"${t}"`).join(", ")}formatArray(n){return n.length===0?"":n.map(t=>`"${t}"`).join(", ")}replacePlaceholders(n,t){let r=n;r=r.replace(/<%[\s\S]*?%>/g,""),r=r.replace(/^%%[\s\S]*?%%$/gm,""),r=r.replace(/\{\{DATE:([^}]+)\}\}/g,(i,s)=>fe(new Date,s));for(let[i,s]of Object.entries(t)){let o=new RegExp(`\\{\\{${i}\\}\\}`,"g");r=r.replace(o,s)}return r=r.replace(/\n{3,}/g,`

`),r.trim()}getDefaultTemplateContent(){return`# {{title}}

%% To use an image URL from the server, use the following syntax: %%
<%* if (tp.frontmatter.cover && tp.frontmatter.cover.trim() !== "") { tR += \`![cover|150](\${tp.frontmatter.cover})\` } %>
`}}});var ze,Ue,kr=B(()=>{ze=require("obsidian");ot();st();Fe();Le();$e();vr();Ue=class{constructor(n){this.app=n,this.folderManager=new re(n),this.templateProcessor=new He}async create(n,t){let r=L.getBooksFolderPath(t);await this.folderManager.ensureFolder(r);let i=ne.generate(n.title),s=(0,ze.normalizePath)(`${r}/${i}.md`),o=this.app.vault.getAbstractFileByPath(s);if(o instanceof ze.TFile)throw new Error(`Book note already exists: ${o.path}`);let a=z.bookToFrontmatter(n),l=Y.create(a),c=this.templateProcessor.getDefaultTemplate(),p=this.templateProcessor.processTemplate(c,n).trim()||`# ${n.title}
`,u=`${l}
${p}`;return await this.app.vault.create(s,u)}}});var le={};Ce(le,{FrontmatterParser:()=>O});var O,V=B(()=>{Et();O=class e{static parse(n){let t=/^---\s*\n([\s\S]*?)\n---\s*\n/,r=n.match(t);if(!r||!r[1])return{};let i=r[1];try{let s=xr(i,{schema:mr});if(!s||typeof s!="object")return{};let o={};for(let[a,l]of Object.entries(s))if(a!=="reading_history"){if(a==="reading_history_summary"){o[a]=e.normalizeReadingHistorySummary(l);continue}if(l===""){a==="title"||a==="status"?o[a]=l:a==="author"&&(o[a]=[]);continue}o[a]=l}return o}catch(s){return console.error("[FrontmatterParser] Error parsing YAML:",s),{}}}static extract(n){let t=/^---\s*\n([\s\S]*?)\n---\s*\n/,r=n.match(t);if(!r)return{frontmatter:{},body:n};let i=e.parse(n),s=n.substring(r[0].length);return{frontmatter:i,body:s}}static normalizeReadingHistorySummary(n){return n==null||n===""?[]:Array.isArray(n)?n.filter(t=>t&&typeof t=="object"&&!Array.isArray(t)):[]}}});var je,Er=B(()=>{je=class{static validateAndFixBook(n){let t={...n};return t.readPage!==void 0&&t.readPage<0&&(t.readPage=0),t.totalPages!==void 0&&t.totalPages<0&&(t.totalPages=void 0),t.readPage!==void 0&&t.totalPages!==void 0&&t.readPage>t.totalPages&&(t.readPage=t.totalPages),t.status&&!["unread","reading","finished"].includes(t.status)&&(t.status="unread"),(!t.title||t.title.trim().length===0)&&(t.title="Unknown title"),t}}});var Ye,$,ve=B(()=>{Ye=require("obsidian");V();Le();Er();st();$=class{constructor(n){this.app=n}async read(n,t=!0){let r=await this.app.vault.read(n),{frontmatter:i}=O.extract(r),s=z.frontmatterToBook(i);return t?je.validateAndFixBook(s):s}async findExisting(n,t){let r=`${ne.generate(t)}.md`,i=(0,Ye.normalizePath)(`${n}/${r}`),s=this.app.vault.getAbstractFileByPath(i);return s instanceof Ye.TFile?s:null}}});var wt={};Ce(wt,{SearchModal:()=>ee});var Ve,ee,ke=B(()=>{Ve=require("obsidian");Bt();kr();ve();Fe();ee=class extends Ve.Modal{constructor(t,r){super(t);this.searchTimeout=null;this.currentResults=[];this.currentOffset=0;this.hasMoreResults=!1;this.isLoadingMore=!1;this.plugin=r,this.openLibraryClient=new Ae(this.plugin.settings.apiTimeout),this.bookFileCreator=new Ue(t),this.bookFileReader=new $(t)}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"Search Books"}),new Ve.Setting(t).setName("Search query").setDesc("Enter book title, author, or ISBN").addText(r=>{this.searchInput=r.inputEl,this.searchInput.placeholder="Search for books...",this.searchInput.addEventListener("input",()=>{this.handleSearchInput()})}),this.loadingIndicator=t.createEl("div",{cls:"bookshelf-loading",text:"Searching..."}),this.loadingIndicator.style.display="none",this.resultsContainer=t.createEl("div",{cls:"bookshelf-search-results"}),this.resultsContainer.style.cssText="max-height: 60vh; overflow-y: auto; margin-top: 16px;",this.resultsContainer.addEventListener("scroll",()=>{this.handleScroll()}),this.searchInput.focus()}onClose(){let{contentEl:t}=this;t.empty(),this.searchTimeout&&(clearTimeout(this.searchTimeout),this.searchTimeout=null)}handleSearchInput(){let t=this.searchInput.value.trim();if(this.searchTimeout&&clearTimeout(this.searchTimeout),t.length<2){this.resultsContainer.empty(),this.hideLoading(),this.hideError(),this.currentResults=[],this.currentOffset=0,this.hasMoreResults=!1;return}this.showLoading(),this.hideError(),this.currentResults=[],this.currentOffset=0,this.hasMoreResults=!1,this.searchTimeout=setTimeout(()=>{this.performSearch(t,0)},500)}async performSearch(t,r=0){try{let i=this.plugin.settings.searchResultLimit||20,s=await this.openLibraryClient.searchBooks(t,i,r);r===0?this.currentResults=s:this.currentResults=[...this.currentResults,...s],this.hasMoreResults=s.length===i,this.currentOffset=r+s.length,this.renderResults(this.currentResults),this.hideLoading(),this.isLoadingMore=!1}catch(i){this.hideLoading(),this.showError("Failed to search books. Please try again later."),r===0&&this.resultsContainer.empty(),this.isLoadingMore=!1}}handleScroll(){if(this.isLoadingMore||!this.hasMoreResults)return;let t=this.resultsContainer,r=t.scrollTop,i=t.scrollHeight,s=t.clientHeight;r+s>=i*.8&&this.loadMoreResults()}async loadMoreResults(){if(this.isLoadingMore||!this.hasMoreResults)return;let t=this.searchInput.value.trim();t&&(this.isLoadingMore=!0,await this.performSearch(t,this.currentOffset))}renderResults(t){if(this.currentOffset===t.length&&this.resultsContainer.empty(),t.length===0&&this.currentOffset===0){this.resultsContainer.createEl("div",{cls:"bookshelf-no-results",text:"No books found. Try a different search query."});return}if(t.forEach((r,i)=>{if(i<this.currentOffset-t.length)return;let s=this.resultsContainer.createEl("div",{cls:"bookshelf-result-item"});if(r.coverUrl){let c=s.createEl("div",{cls:"bookshelf-result-cover"}).createEl("img",{attr:{src:r.coverUrl,alt:r.title}});c.style.width="80px",c.style.height="120px",c.style.objectFit="cover"}let o=s.createEl("div",{cls:"bookshelf-result-info"});o.createEl("div",{cls:"bookshelf-result-title",text:r.title}),r.author&&r.author.length>0&&o.createEl("div",{cls:"bookshelf-result-author",text:`by ${r.author.join(", ")}`}),r.publishDate&&o.createEl("div",{cls:"bookshelf-result-meta",text:`Published: ${r.publishDate}`}),r.publisher&&o.createEl("div",{cls:"bookshelf-result-meta",text:`Publisher: ${r.publisher}`}),o.createEl("button",{cls:"mod-cta",text:"Add Book"}).addEventListener("click",async()=>{await this.addBook(r)}),i<t.length-1&&s.createEl("hr")}),this.isLoadingMore){let r=this.resultsContainer.createEl("div",{cls:"bookshelf-loading-more",text:"Loading more..."});r.style.cssText="text-align: center; padding: 16px; color: var(--text-muted);"}}async addBook(t){try{this.setButtonsState(!0,"Adding...");let i={...await this.fetchDetailedBookInfo(t),status:this.plugin.settings.defaultStatus};await this.validateBookNotExists(i);let s=await this.bookFileCreator.create(i,this.plugin.settings.bookFolder);this.showSuccess(`Book "${i.title}" added successfully!`),this.triggerViewRefresh(s),setTimeout(()=>this.close(),1e3),this.setButtonsState(!1,"Add Book")}catch(r){this.showError(`Failed to add book: ${r instanceof Error?r.message:"Unknown error"}`),this.setButtonsState(!1,"Add Book")}}async fetchDetailedBookInfo(t){if(!t.coverEditionKey)return t;let r=await this.openLibraryClient.getBookByOLID(t.coverEditionKey);return r?{...t,...r,totalPages:r.totalPages||t.totalPages,coverUrl:r.coverUrl||t.coverUrl,title:r.title||t.title,author:r.author.length>0?r.author:t.author,publisher:r.publisher||t.publisher,publishDate:r.publishDate||t.publishDate}:t}async validateBookNotExists(t){let r=L.getBooksFolderPath(this.plugin.settings.bookFolder);if(await this.bookFileReader.findExisting(r,t.title))throw new Error(`Book "${t.title}" already exists.`)}setButtonsState(t,r){this.resultsContainer.querySelectorAll("button").forEach(s=>{s.disabled=t,s.textContent=r})}triggerViewRefresh(t){try{this.app.vault.trigger("modify",t),this.app.workspace.iterateAllLeaves(r=>{var i,s;if(((s=(i=r.view)==null?void 0:i.getViewType)==null?void 0:s.call(i))==="bases"){let o=r.view;typeof o.requestUpdate=="function"?o.requestUpdate():typeof o.refresh=="function"&&o.refresh()}})}catch(r){console.debug("[Bookshelf] Error triggering Bases refresh:",r)}}showLoading(){this.loadingIndicator.style.display="block"}hideLoading(){this.loadingIndicator.style.display="none"}showError(t){let r=this.contentEl.querySelector(".bookshelf-message");r&&r.remove();let i=this.contentEl.createEl("div",{cls:"bookshelf-message bookshelf-message-error"});i.createEl("div",{cls:"bookshelf-message-icon",text:"!"}),i.createEl("div",{cls:"bookshelf-message-text",text:t}),i.createEl("button",{cls:"bookshelf-message-close",text:"Dismiss"}).addEventListener("click",()=>i.remove())}hideError(){let t=this.contentEl.querySelector(".bookshelf-message");t&&t.remove()}showSuccess(t){let r=this.contentEl.querySelector(".bookshelf-message-success");r&&r.remove();let i=this.contentEl.createEl("div",{cls:"bookshelf-message-success"});i.style.cssText="padding: 12px; margin-top: 16px; background-color: transparent; color: var(--interactive-accent); font-size: 14px; text-align: center; font-weight: 500;",i.createEl("span",{text:t})}}});var po={};Ce(po,{default:()=>Xe});module.exports=Mr(po);var I=require("obsidian");var Ct={bookFolder:"Bookshelf",apiTimeout:5e3,searchResultLimit:20,defaultSort:"date",autoUpdateTimestamp:!0,autoStatusChange:!0,showProgressNotification:!0,trackReadingHistory:!0,requireReadingNotes:!1,defaultStatus:"unread",timezone:0};var C=require("obsidian"),Te=class extends C.PluginSettingTab{constructor(n,t){super(n,t),this.plugin=t}display(){let{containerEl:n}=this;n.empty(),new C.Setting(n).setName("General").setHeading(),new C.Setting(n).setName("Folders").setHeading(),new C.Setting(n).setName("Book notes folder").setDesc("Folder path where book notes will be saved").addText(t=>t.setPlaceholder("Books").setValue(this.plugin.settings.bookFolder).onChange(async r=>{this.plugin.settings.bookFolder=r,await this.plugin.saveSettings()})),new C.Setting(n).setName("API").setHeading(),new C.Setting(n).setName("Timeout (ms)").setDesc("Timeout duration for Open Library API requests (in milliseconds)").addText(t=>t.setPlaceholder("5000").setValue(this.plugin.settings.apiTimeout.toString()).onChange(async r=>{let i=parseInt(r,10);!isNaN(i)&&i>0&&(this.plugin.settings.apiTimeout=i,await this.plugin.saveSettings())})),new C.Setting(n).setName("Search result limit").setDesc("Maximum number of search results to display").addText(t=>t.setPlaceholder("20").setValue(this.plugin.settings.searchResultLimit.toString()).onChange(async r=>{let i=parseInt(r,10);!isNaN(i)&&i>0&&(this.plugin.settings.searchResultLimit=i,await this.plugin.saveSettings())})),new C.Setting(n).setName("Auto update").setHeading(),new C.Setting(n).setName("Auto update timestamp").setDesc("Whether to automatically update the updated field when book information is modified").addToggle(t=>t.setValue(this.plugin.settings.autoUpdateTimestamp).onChange(async r=>{this.plugin.settings.autoUpdateTimestamp=r,await this.plugin.saveSettings(),r&&this.plugin.registerAutoUpdateTimestamp()})),new C.Setting(n).setName("Auto status change").setDesc('Automatically change status to "finished" when read_page reaches total pages').addToggle(t=>t.setValue(this.plugin.settings.autoStatusChange).onChange(async r=>{this.plugin.settings.autoStatusChange=r,await this.plugin.saveSettings()})),new C.Setting(n).setName("Show progress notification").setDesc("Show notification when progress is updated").addToggle(t=>t.setValue(this.plugin.settings.showProgressNotification).onChange(async r=>{this.plugin.settings.showProgressNotification=r,await this.plugin.saveSettings()})),new C.Setting(n).setName("Reading history").setHeading(),new C.Setting(n).setName("Track reading history").setDesc("Whether to track reading history (pages read per session)").addToggle(t=>t.setValue(this.plugin.settings.trackReadingHistory).onChange(async r=>{this.plugin.settings.trackReadingHistory=r,await this.plugin.saveSettings()})),new C.Setting(n).setName("Require reading notes").setDesc("Require notes when updating reading progress").addToggle(t=>t.setValue(this.plugin.settings.requireReadingNotes).onChange(async r=>{this.plugin.settings.requireReadingNotes=r,await this.plugin.saveSettings()})),new C.Setting(n).setName("View").setHeading(),new C.Setting(n).setName("Default sort order").setDesc("Default sort order for bookshelf view").addDropdown(t=>t.addOption("date","Date").addOption("title","Title").addOption("author","Author").addOption("progress","Progress").setValue(this.plugin.settings.defaultSort).onChange(async r=>{this.plugin.settings.defaultSort=r,await this.plugin.saveSettings()})),new C.Setting(n).setName("Default values").setHeading(),new C.Setting(n).setName("Default reading status").setDesc("Default reading status for newly added books").addDropdown(t=>t.addOption("unread","Unread").addOption("reading","Reading").setValue(this.plugin.settings.defaultStatus).onChange(async r=>{this.plugin.settings.defaultStatus=r,await this.plugin.saveSettings()})),new C.Setting(n).setName("Date & time").setHeading(),new C.Setting(n).setName("Timezone offset").setDesc("Timezone offset from UTC in hours (e.g., 0 for UTC, 9 for KST, -5 for EST)").addText(t=>t.setPlaceholder("0").setValue(this.plugin.settings.timezone.toString()).onChange(async r=>{let i=parseFloat(r);!isNaN(i)&&i>=-12&&i<=14&&(this.plugin.settings.timezone=i,await this.plugin.saveSettings())}))}};ke();function wr(e,n){n.addCommand({id:"bookshelf-search-book",name:"Search book",callback:()=>{new ee(e,n).open()}})}var de=require("obsidian");function Cr(e){if(e.length===0)return 0;let t=[...e].sort((r,i)=>new Date(i.date).getTime()-new Date(r.date).getTime())[0];return t?t.endPage:0}ve();V();Le();$e();Q();var ce=class{static parseFromBody(n){let t=[],r=/^##\s+Reading History\s*\n([\s\S]*?)(?=\n##|\n#|$)/m,i=n.match(r);if(!i||!i[1])return t;let s=i[1],o=/(?:^###\s+(\d{4}-\d{2}-\d{2})|^-\s+\*\*Date:\*\*\s+(\d{4}-\d{2}-\d{2}))\s*\n([\s\S]*?)(?=\n(?:###|-\s+\*\*Date:)|$)/gm,a;for(;(a=o.exec(s))!==null;){let l=a[1]||a[2]||"",c=a[3]||"",d=c.match(/(?:\*\*Start Page:\*\*|Start Page:|Start:|From:)\s*(\d+)/i),p=c.match(/(?:\*\*End Page:\*\*|End Page:|End:|To:|Page:)\s*(\d+)/i),u=c.match(/(?:\*\*Pages Read:\*\*|Pages Read:|Pages:|Read:)\s*(\d+)/i),h=c.match(/(?:\*\*Timestamp:\*\*|Timestamp:|Time:)\s*([^\n]+)/i),x,g=c.match(/(?:Notes?:|Note:)\s*\n?([\s\S]*?)(?=\n(?:Time|Timestamp)|$)/i);g&&g[1]&&(x=g[1].trim(),x===""&&(x=void 0));let m={date:l,startPage:d&&d[1]?parseInt(d[1],10):0,endPage:p&&p[1]?parseInt(p[1],10):0,pagesRead:u&&u[1]?parseInt(u[1],10):0,notes:x,timestamp:h&&h[1]?h[1].trim():void 0};m.pagesRead===0&&m.endPage>m.startPage&&(m.pagesRead=m.endPage-m.startPage),t.push(m)}return t}static updateInBody(n,t){var l,c,d;let r=[];r.push("## Reading History"),r.push("");let i=[...t].sort((p,u)=>{let h=p.timestamp||p.date||"";return(u.timestamp||u.date||"").localeCompare(h)});for(let p of i){if(r.push(`### ${p.date||"Unknown Date"}`),r.push(""),r.push(`- **Start Page:** ${(l=p.startPage)!=null?l:0}`),r.push(`- **End Page:** ${(c=p.endPage)!=null?c:0}`),r.push(`- **Pages Read:** ${(d=p.pagesRead)!=null?d:0}`),p.timestamp&&r.push(`- **Timestamp:** ${p.timestamp}`),p.notes){r.push("- **Notes:**"),r.push("");let u=p.notes.split(`
`);for(let h of u)r.push(`  ${h}`)}r.push("")}let s=r.join(`
`),o=/^##\s+Reading History\s*\n[\s\S]*?(?=\n##|\n#|$)/m,a=n;if(o.test(n))a=n.replace(o,s);else{let p=/^(##\s+[^\n]+)/m;p.test(n)?a=n.replace(p,`${s}

$1`):a=n.trim()+`

`+s}return a}static createRecord(n,t,r){let i=R();return{date:i.split(" ")[0]||i,startPage:n,endPage:t,pagesRead:Math.max(0,t-n),notes:r||void 0,timestamp:i}}};Q();var G=class{constructor(n){this.app=n}async updateBook(n,t){let r=await this.app.vault.read(n),{frontmatter:i,body:s}=O.extract(r),a={...z.frontmatterToBook(i),...t},l=z.bookToFrontmatter(a);l.updated=R();let d=`${Y.create(l)}
${s}`;await this.app.vault.modify(n,d)}async updateReadingProgress(n,t,r,i,s=!0){var b;let o=await this.app.vault.read(n),{frontmatter:a,body:l}=O.extract(o);if(a.read_page=t,s){let f=typeof a.total=="number"?a.total:typeof a.totalPages=="number"?a.totalPages:void 0;f&&t>=f?(a.status="finished",a.read_finished||(a.read_finished=R())):t>0&&a.status==="unread"&&(a.status="reading",a.read_started||(a.read_started=R()))}a.updated=R();let c=ce.parseFromBody(l),d=c.length>0?c[c.length-1]:null,p=typeof a.read_page=="number"?a.read_page:0,u=r!==void 0?r:(b=d==null?void 0:d.endPage)!=null?b:p,h=ce.createRecord(u,t,i);c.push(h),(!a.reading_history_summary||!Array.isArray(a.reading_history_summary))&&(a.reading_history_summary=[]),a.reading_history_summary.push({date:h.date,startPage:h.startPage,endPage:h.endPage,pagesRead:h.pagesRead,timestamp:h.timestamp||"",notes:h.notes});let x=ce.updateInBody(l,c),m=`${Y.create(a)}
${x}`;await this.app.vault.modify(n,m)}};var K=class extends de.Modal{constructor(t,r,i){super(t);this.book=null;this.plugin=r,this.bookFileReader=new $(t),this.bookFileUpdater=new G(t),this.file=i||this.app.workspace.getActiveFile()}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"Update Reading Progress"}),this.loadBookData().then(()=>{if(!this.book){t.createEl("div",{cls:"bookshelf-error",text:"No book data found. Please open a book note first."});return}this.renderForm(t)})}onClose(){let{contentEl:t}=this;t.empty()}async loadBookData(){if(this.file)try{let t=await this.bookFileReader.read(this.file);t.title&&(this.book={title:t.title||"Unknown",subtitle:t.subtitle,author:t.author||[],isbn10:t.isbn10,isbn13:t.isbn13,publisher:t.publisher,publishDate:t.publishDate,totalPages:t.totalPages,coverUrl:t.coverUrl,category:t.category||[],status:t.status||"unread",readPage:t.readPage||0,readStarted:t.readStarted,readFinished:t.readFinished,created:t.created||new Date().toISOString(),updated:t.updated||new Date().toISOString()})}catch(t){console.error("Error loading book data:",t)}}renderForm(t){if(!this.book||!this.file)return;let r=t.createEl("div",{cls:"bookshelf-progress-book-info"});r.createEl("div",{cls:"bookshelf-progress-title",text:this.book.title}),this.book.author&&this.book.author.length>0&&r.createEl("div",{cls:"bookshelf-progress-author",text:`by ${this.book.author.join(", ")}`}),this.app.vault.read(this.file).then(async i=>{var g;let{FrontmatterParser:s}=await Promise.resolve().then(()=>(V(),le)),{frontmatter:o}=s.extract(i),l=(o.reading_history_summary||[]).map(m=>({date:m.date||"",startPage:m.startPage||0,endPage:m.endPage||0,pagesRead:m.pagesRead||0,timestamp:m.timestamp})),c=Cr(l),d=((g=this.book)==null?void 0:g.readPage)||0;new de.Setting(t).setName("Start page").setDesc("Starting page for this reading session").addText(m=>{this.startPageInput=m.inputEl,this.startPageInput.type="number",this.startPageInput.value=c>0?c.toString():(d||"0").toString(),this.startPageInput.addEventListener("input",()=>this.updateCalculations())}),new de.Setting(t).setName("End page").setDesc("Current page you finished reading").addText(m=>{this.endPageInput=m.inputEl,this.endPageInput.type="number",this.endPageInput.value=(d||"0").toString(),this.endPageInput.addEventListener("input",()=>this.updateCalculations())});let p=t.createEl("div",{cls:"bookshelf-progress-calc"});if(p.createEl("div",{cls:"bookshelf-progress-label",text:"Pages read:"}),this.pagesReadDisplay=p.createEl("div",{cls:"bookshelf-progress-value",text:"0"}),this.book&&this.book.totalPages){let m=t.createEl("div",{cls:"bookshelf-progress-calc"});m.createEl("div",{cls:"bookshelf-progress-label",text:"Progress:"}),this.progressDisplay=m.createEl("div",{cls:"bookshelf-progress-value",text:"0%"})}let u=new de.Setting(t).setName("Notes (optional)").setDesc("Add notes about this reading session");this.notesInput=u.controlEl.createEl("textarea",{cls:"bookshelf-notes-input"}),this.notesInput.placeholder="What did you read? Any thoughts?",this.notesInput.style.cssText=`
				width: 100%;
				min-height: 300px;
				padding: 12px;
				font-size: 14px;
				line-height: 1.6;
				font-family: var(--font-text);
				border: 1px solid var(--background-modifier-border);
				border-radius: 4px;
				background-color: var(--background-primary);
				color: var(--text-normal);
				resize: vertical;
				margin-top: 8px;
			`,this.updateCalculations(),t.createEl("div",{cls:"bookshelf-progress-buttons"}).createEl("button",{cls:"mod-cta",text:"Update Progress"}).addEventListener("click",()=>{this.updateProgress()})})}updateCalculations(){var s;let t=parseInt(this.startPageInput.value,10)||0,r=parseInt(this.endPageInput.value,10)||0,i=Math.max(0,r-t);if(this.pagesReadDisplay.textContent=i.toString(),(s=this.book)!=null&&s.totalPages&&this.progressDisplay){let o=Math.min(r/this.book.totalPages*100,100);this.progressDisplay.textContent=`${Math.round(o)}%`}}async updateProgress(){if(!this.file||!this.book)return;let t=parseInt(this.startPageInput.value,10)||0,r=parseInt(this.endPageInput.value,10)||0,i=Math.max(0,r-t),s=this.notesInput.value.trim()||void 0;if(this.plugin.settings.requireReadingNotes&&!s){this.showErrorMessage("Notes are required when updating progress.");return}if(r<t){this.showErrorMessage("End page must be greater than or equal to start page.");return}try{await this.bookFileUpdater.updateReadingProgress(this.file,r,t,s,this.plugin.settings.autoStatusChange),this.showSuccessMessage("Progress updated successfully!")}catch(o){this.showErrorMessage(`Failed to update progress: ${o instanceof Error?o.message:"Unknown error"}`)}}showSuccessMessage(t){let r=this.contentEl.querySelector(".bookshelf-progress-success");r&&r.remove();let i=this.contentEl.createEl("div",{cls:"bookshelf-progress-success"});i.style.cssText="padding: 12px; margin-top: 16px; background-color: transparent; color: var(--interactive-accent); font-size: 14px; text-align: center; font-weight: 500;";let s=i.createEl("span",{text:t});setTimeout(()=>{this.close()},2e3)}showErrorMessage(t){let r=this.contentEl.querySelector(".bookshelf-message");r&&r.remove();let i=this.contentEl.createEl("div",{cls:"bookshelf-message bookshelf-message-error"}),s=i.createEl("div",{cls:"bookshelf-message-icon",text:"!"}),o=i.createEl("div",{cls:"bookshelf-message-text",text:t});i.createEl("button",{cls:"bookshelf-message-close",text:"Dismiss"}).addEventListener("click",()=>{i.remove()})}};function Tr(e,n){n.addCommand({id:"bookshelf-update-progress",name:"Update reading progress",callback:()=>{let t=e.workspace.getActiveFile();new K(e,n,t).open()}})}function Sr(e,n){wr(e,n),Tr(e,n)}ot();Fe();V();$e();ke();Q();var Br=require("obsidian");function co(e){var n,t;try{let i=e.internalPlugins;if(!i)return console.debug("[Bookshelf][Bases] Internal plugins manager not available"),null;let s=(n=i.getEnabledPluginById)==null?void 0:n.call(i,"bases");return s?!s.registrations||typeof s.registrations!="object"?(console.warn("[Bookshelf][Bases] Bases plugin found but registrations API not available"),null):{registrations:s.registrations,isEnabled:!0,version:((t=s.manifest)==null?void 0:t.version)||"unknown"}:(console.debug("[Bookshelf][Bases] Bases plugin not found or not enabled"),null)}catch(r){return console.warn("[Bookshelf][Bases] Error accessing Bases plugin API:",r),null}}function Ee(e,n,t){var i;let r=e;if(typeof r.registerBasesView=="function")try{return r.registerBasesView(n,t)?(console.debug(`[Bookshelf][Bases] Successfully registered view via public API: ${n}`),!0):(console.debug("[Bookshelf][Bases] Public API returned false (Bases may be disabled)"),!1)}catch(s){let o=s;return(i=o==null?void 0:o.message)!=null&&i.includes("already exists")?(console.debug(`[Bookshelf][Bases] View ${n} already registered via public API`),!0):(console.warn(`[Bookshelf][Bases] Public API registration failed for ${n}:`,s),!1)}return console.warn("[Bookshelf][Bases] Cannot register view: Bases public API not available (requires Obsidian 1.10.0+)"),!1}function we(e,n){let t=co(e.app);if(!t)return!0;try{return t.registrations[n]&&delete t.registrations[n],!0}catch(r){return console.error(`[Bookshelf][Bases] Error unregistering view ${n}:`,r),!1}}var Ar=require("obsidian");var pe=require("obsidian");ve();var H=class extends pe.Component{constructor(t,r,i){super();this.rootElement=null;this.updateDebounceTimer=null;this.dataUpdateDebounceTimer=null;this.plugin=i,this.containerEl=r,this.bookFileReader=new $(i.app),this.bookFileUpdater=new G(i.app)}onload(){this.setupContainer(),requestAnimationFrame(()=>{setTimeout(()=>{var t;(t=this.rootElement)!=null&&t.isConnected&&this.render()},100)})}onDataUpdated(){var r;if(!((r=this.rootElement)!=null&&r.isConnected))return;this.dataUpdateDebounceTimer&&clearTimeout(this.dataUpdateDebounceTimer);let t=this.containerEl.ownerDocument.defaultView||window;this.dataUpdateDebounceTimer=t.setTimeout(()=>{this.dataUpdateDebounceTimer=null;try{this.render()}catch(i){console.error(`[Bookshelf][${this.type}] Render error:`,i),this.renderError(i)}},500)}onunload(){this.dataUpdateDebounceTimer&&clearTimeout(this.dataUpdateDebounceTimer),this.updateDebounceTimer&&clearTimeout(this.updateDebounceTimer),super.onunload()}setupContainer(){let r=this.containerEl.ownerDocument.createElement("div");r.className="bookshelf-bases-view",r.style.cssText="display: flex; flex-direction: column; height: 100%; width: 100%;",r.tabIndex=-1,this.containerEl.appendChild(r),this.rootElement=r,this.setupNewBookButton()}setupNewBookButton(){let t=0,r=10,i=()=>{t++,this.injectNewBookButton();let s=this.containerEl.closest(".bases-view"),o=s==null?void 0:s.parentElement,a=o==null?void 0:o.querySelector(".bases-toolbar");!(a==null?void 0:a.querySelector(".bookshelf-bases-new-book-btn"))&&t<r&&setTimeout(i,200)};setTimeout(i,100),this.register(()=>this.cleanupNewBookButton())}cleanupNewBookButton(){let t=this.containerEl.closest(".bases-view"),r=t==null?void 0:t.parentElement;r==null||r.classList.remove("bookshelf-view-active")}injectNewBookButton(){let t=this.containerEl.closest(".bases-view");if(!t){console.debug("[Bookshelf][Bases] No .bases-view found");return}let r=t.parentElement;if(!r){console.debug("[Bookshelf][Bases] No parent element found");return}r.classList.add("bookshelf-view-active");let i=r.querySelector(".bases-toolbar");if(!i){console.debug("[Bookshelf][Bases] No .bases-toolbar found in parent");return}if(i.querySelector(".bookshelf-bases-new-book-btn"))return;let s=this.containerEl.ownerDocument,o=s.createElement("div");o.className="bases-toolbar-item bookshelf-bases-new-book-btn";let a=s.createElement("div");a.className="text-icon-button",a.tabIndex=0;let l=s.createElement("span");l.className="text-button-icon",(0,pe.setIcon)(l,"book-plus"),a.appendChild(l);let c=s.createElement("span");c.className="text-button-label",c.textContent="New book",a.appendChild(c),o.appendChild(a);let d=async u=>{u.stopPropagation(),u.preventDefault(),u.stopImmediatePropagation();let h=this.app||this.plugin.app;if(!h){console.error("[Bookshelf][Bases] App not available");return}try{let{SearchModal:x}=await Promise.resolve().then(()=>(ke(),wt));new x(h,this.plugin).open()}catch(x){console.error("[Bookshelf][Bases] Error opening search modal:",x)}};a.addEventListener("click",d,{capture:!0,once:!1}),a.addEventListener("mousedown",u=>{u.button===0&&d(u)},{capture:!0}),a.addEventListener("keydown",u=>{(u.key==="Enter"||u.key===" ")&&(u.stopPropagation(),u.preventDefault(),d(u))});let p=i.querySelector(".bases-toolbar-new-item-menu");p?p.before(o):i.appendChild(o),console.debug("[Bookshelf][Bases] Injected New Book button into toolbar")}extractDataItems(){var r;return(r=this.data)!=null&&r.data?this.data.data.map(i=>{var o;let s=i;return(o=s==null?void 0:s.file)!=null&&o.path?{key:s.file.path,data:s,file:s.file,path:s.file.path,properties:this.extractEntryProperties(s),basesData:s}:(console.warn("[Bookshelf][BasesView] Entry missing file.path:",s),null)}).filter(i=>i!==null):(console.warn("[Bookshelf][BasesView] No data available"),[])}extractEntryProperties(t){let r={};return t.note&&Object.assign(r,t.note),t.file&&(r["file.name"]=t.file.name,r["file.path"]=t.file.path,r["file.ctime"]=t.file.ctime,r["file.mtime"]=t.file.mtime),r}async extractBooksFromBasesData(t){let r=[];for(let i of t)try{let s=i.file;if(!s||!s.path)continue;let o=this.app||this.plugin.app;if(!o)continue;let a=o.vault.getAbstractFileByPath(s.path);if(!a||!(a instanceof pe.TFile))continue;let l=await this.bookFileReader.read(a);if(l.title){let c,d;try{let x=await o.vault.read(a),{FrontmatterParser:g}=await Promise.resolve().then(()=>(V(),le)),{frontmatter:m}=g.extract(x),b=m.reading_history_summary;if(b&&Array.isArray(b)&&b.length>0){let y=[...b].sort((E,k)=>{let w=E,T=k,D=w.date||w.timestamp||"";return(T.date||T.timestamp||"").localeCompare(D)})[0];y!=null&&y.date?c=y.date:y!=null&&y.timestamp&&(c=y.timestamp.split(" ")[0]),d=b.reduce((E,k)=>E+(k.pagesRead||0),0)}}catch(x){}let p=d!==void 0&&d>(l.readPage||0)?d:l.readPage,u=l.status==="unread"||l.status==="reading"||l.status==="finished"?l.status:"unread",h={title:l.title||"Unknown",subtitle:l.subtitle,author:l.author||[],isbn10:l.isbn10,isbn13:l.isbn13,publisher:l.publisher,publishDate:l.publishDate,totalPages:l.totalPages,coverUrl:l.coverUrl,category:l.category||[],status:u,readPage:p,readStarted:l.readStarted,readFinished:l.readFinished,created:l.created||new Date().toISOString(),updated:l.updated||new Date().toISOString(),lastReadDate:c};r.push({book:h,file:a})}}catch(s){console.error("[Bookshelf] Error extracting book from Bases data:",s)}return r}renderError(t){if(!this.rootElement)return;let r=this.rootElement.ownerDocument;this.rootElement.empty();let i=r.createElement("div");i.className="bookshelf-error",i.style.cssText="padding: 20px; text-align: center; color: var(--text-error);",i.textContent=`Error: ${t.message}`,this.rootElement.appendChild(i)}getEphemeralState(){var t;return{scrollTop:((t=this.rootElement)==null?void 0:t.scrollTop)||0}}setEphemeralState(t){if(!(!t||!this.rootElement||!this.rootElement.isConnected))try{let r=t;r.scrollTop!==void 0&&(this.rootElement.scrollTop=r.scrollTop)}catch(r){console.debug("[Bookshelf][Bases] Failed to restore ephemeral state:",r)}}focus(){var t;try{(t=this.rootElement)!=null&&t.isConnected&&typeof this.rootElement.focus=="function"&&this.rootElement.focus()}catch(r){console.debug("[Bookshelf][Bases] Failed to focus view:",r)}}refresh(){this.render()}onResize(){}};var ue=class{constructor(n,t,r=null,i){this.app=n,this.book=t,this.file=r,this.plugin=i||null}render(n="grid"){return this.book.status==="reading"?this.renderReadingBook(n):this.renderShelfBook(n)}renderReadingBook(n){let t=document.createElement("div");if(t.className=`bookshelf-book-card bookshelf-book-reading bookshelf-layout-${n}`,t.style.cssText="min-height: 420px; display: flex; flex-direction: column;",this.book.coverUrl){let o=t.createEl("div",{cls:"bookshelf-book-cover"});o.style.cssText="width: 100%; height: 240px; margin-bottom: 16px; flex-shrink: 0;";let a=o.createEl("img",{attr:{src:this.book.coverUrl||"",alt:this.book.title||"Book cover"}});a.style.cssText="width: 100%; height: 100%; object-fit: cover; border-radius: 6px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);",a.addEventListener("error",()=>{a.style.display="none"})}let r=t.createEl("div",{cls:"bookshelf-book-info"});r.style.cssText="padding: 0 12px 12px 12px; flex: 1; display: flex; flex-direction: column;",r.createEl("div",{cls:"bookshelf-book-title",text:this.book.title}).style.cssText="font-size: 17px; font-weight: 600; margin-bottom: 8px; line-height: 1.4; color: var(--text-normal);",this.book.author&&this.book.author.length>0&&(r.createEl("div",{cls:"bookshelf-book-author",text:this.book.author.join(", ")}).style.cssText="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;");let i=this.book.lastReadDate,s=r.createEl("div",{cls:"bookshelf-reading-status"});if(s.style.cssText="font-size: 12px; color: var(--text-muted); margin-bottom: 16px; padding: 12px; background-color: var(--background-secondary); border-radius: 6px; display: flex; flex-direction: column; gap: 8px;",this.book.readStarted){let o=s.createEl("div");o.style.cssText="display: flex; justify-content: space-between; align-items: center;";let a=o.createEl("span",{text:"Started:"});a.style.cssText="color: var(--text-faint); font-size: 11px;";let l=typeof this.book.readStarted=="string"?this.book.readStarted.includes("T")?this.book.readStarted.split("T")[0]:this.book.readStarted.split(" ")[0]:String(this.book.readStarted),c=o.createEl("span",{text:l});c.style.cssText="font-weight: 600; color: var(--text-normal); font-size: 12px;"}else{let o=s.createEl("div");o.style.cssText="display: flex; justify-content: space-between; align-items: center;";let a=o.createEl("span",{text:"Started:"});a.style.cssText="color: var(--text-faint); font-size: 11px;";let l=o.createEl("span",{text:"Not started"});l.style.cssText="font-weight: 400; color: var(--text-muted); font-size: 12px; font-style: italic;"}if(i){let o=s.createEl("div");o.style.cssText="display: flex; justify-content: space-between; align-items: center;";let a=o.createEl("span",{text:"Last read:"});a.style.cssText="color: var(--text-faint); font-size: 11px;";let l=o.createEl("span",{text:i});l.style.cssText="font-weight: 700; color: var(--interactive-accent); font-size: 12px;"}else if(this.book.readStarted){let o=s.createEl("div");o.style.cssText="display: flex; justify-content: space-between; align-items: center;";let a=o.createEl("span",{text:"Last read:"});a.style.cssText="color: var(--text-faint); font-size: 11px;";let l=o.createEl("span",{text:"Not yet"});l.style.cssText="font-weight: 400; color: var(--text-muted); font-size: 12px; font-style: italic;"}if(this.book.totalPages!==void 0&&this.book.totalPages!==null&&this.book.totalPages>0){let o=this.book.readPage||0,a=Math.min(o/this.book.totalPages*100,100),l=Math.max(0,this.book.totalPages-o),c=r.createEl("div",{cls:"bookshelf-progress-container"});c.style.cssText="margin-bottom: 16px;";let d=c.createEl("div");d.style.cssText="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;";let p=d.createEl("div");p.style.cssText="font-size: 12px; font-weight: 600; color: var(--text-normal);",p.textContent="Progress";let u=d.createEl("div");u.style.cssText="font-size: 14px; font-weight: 700; color: var(--interactive-accent);",u.textContent=`${Math.round(a)}%`;let h=c.createEl("div",{cls:"bookshelf-progress-bar"});h.style.cssText="width: 100%; height: 10px; background-color: var(--background-modifier-border); border-radius: 5px; overflow: hidden; margin-bottom: 6px;";let x=c.createEl("div",{cls:"bookshelf-progress-fill"});x.style.cssText=`width: ${a}%; height: 100%; background-color: var(--interactive-accent); transition: width 0.3s; border-radius: 5px;`,h.appendChild(x);let g=c.createEl("div");g.style.cssText="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted);";let m=g.createEl("span");m.textContent=`Read: ${o} pages`;let b=g.createEl("span");b.textContent=`Remaining: ${l} pages`}else{let o=r.createEl("div");o.style.cssText="padding: 12px; background: var(--background-secondary); border-radius: 6px; margin-bottom: 16px;";let a=o.createEl("div");a.style.cssText="font-size: 12px; color: var(--text-muted); text-align: center;",a.textContent="Please set total pages in frontmatter to track progress"}if(this.plugin&&this.file){let o=r.createEl("div",{cls:"bookshelf-card-actions"});o.style.cssText="margin-top: auto; padding-top: 12px;";let a=o.createEl("button",{cls:"mod-cta",text:"Update Progress"});a.style.cssText="width: 100%; padding: 10px; font-size: 13px; font-weight: 600;",a.addEventListener("click",l=>{l.stopPropagation(),new K(this.app,this.plugin,this.file).open()})}return this.file&&(t.addEventListener("click",o=>{o.target.closest("button")||this.app.workspace.openLinkText(this.file.path,"",!1)}),t.style.cursor="pointer"),t}renderShelfBook(n){let t=document.createElement("div");t.className=`bookshelf-book-card bookshelf-book-shelf bookshelf-status-${this.book.status} bookshelf-layout-${n}`;let r=t.createEl("div",{cls:"bookshelf-book-spine"});r.createEl("div",{cls:"bookshelf-spine-title",text:this.book.title}),this.book.author&&this.book.author.length>0&&r.createEl("div",{cls:"bookshelf-spine-author",text:this.book.author.join(", ")});let i=r.createEl("div",{cls:"bookshelf-status-badge",text:this.book.status==="finished"?"Finished":"Unread"});return this.book.status==="finished"&&this.book.readFinished&&r.createEl("div",{cls:"bookshelf-spine-meta",text:`Finished: ${this.book.readFinished.split(" ")[0]}`}),this.file&&(t.addEventListener("click",()=>{this.app.workspace.openLinkText(this.file.path,"",!1)}),t.style.cursor="pointer"),t}};ve();var qe=class extends H{constructor(){super(...arguments);this.type="bookshelfView";this.books=[]}onload(){super.onload()}async render(){var t;if(this.rootElement&&(t=this.data)!=null&&t.data)try{let r=this.extractDataItems();this.books=await this.extractBooksFromBasesData(r),this.rootElement.empty(),this.renderContent()}catch(r){console.error("[Bookshelf][BasesView] Render error:",r),this.renderError(r)}}renderContent(){if(!this.rootElement)return;let r=this.rootElement.ownerDocument.createElement("div");r.style.cssText="flex: 1; overflow-y: auto; padding: 12px;";let i=this.books.filter(({book:o})=>o.status==="reading"),s=this.books.filter(({book:o})=>o.status==="unread");i.sort((o,a)=>this.sortBooks(o.book,a.book)),s.sort((o,a)=>this.sortBooks(o.book,a.book)),i.length>0?this.renderReadingSection(r,i):this.renderEmptyReadingSection(r),s.length>0?this.renderUnreadSubSection(r,s):this.renderEmptyUnreadSection(r),i.length===0&&s.length===0&&(r.empty(),this.renderEmptyState(r)),this.rootElement.appendChild(r)}renderReadingSection(t,r){let i=t.ownerDocument,s=i.createElement("div");s.className="bookshelf-section-header",s.style.cssText="margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--background-modifier-border);";let o=i.createElement("h2");o.textContent=`Reading (${r.length})`,o.style.cssText="margin: 0; font-size: 1.5em; font-weight: 600;",s.appendChild(o),t.appendChild(s);let a=i.createElement("div");a.className="bookshelf-section-books bookshelf-layout-grid bookshelf-drop-zone",a.style.cssText="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; min-height: 100px;";let l=u=>{u.preventDefault(),u.stopPropagation(),u.dataTransfer&&(u.dataTransfer.dropEffect="move"),a.classList.add("drag-over")},c=u=>{u.preventDefault(),u.stopPropagation(),a.classList.add("drag-over")},d=u=>{u.preventDefault(),u.stopPropagation();let h=a.getBoundingClientRect(),x=u.clientX,g=u.clientY;(x<h.left||x>h.right||g<h.top||g>h.bottom)&&a.classList.remove("drag-over")};a.addEventListener("dragover",l,!1),a.addEventListener("dragenter",c,!1),a.addEventListener("dragleave",d,!1);let p=async u=>{var h,x,g;u.preventDefault(),u.stopPropagation(),u.stopImmediatePropagation(),a.classList.remove("drag-over");try{let m=null;try{let b=(h=u.dataTransfer)==null?void 0:h.getData("application/bookshelf-book");b&&b.trim()&&(m=JSON.parse(b).path)}catch(b){}if(!m)try{let b=(x=u.dataTransfer)==null?void 0:x.getData("text/plain");b&&b.trim()&&(m=b.trim())}catch(b){}m?await this.handleBookStatusChange(m,"reading"):console.warn("[Bookshelf] No file path found in drop data. Available types:",Array.from(((g=u.dataTransfer)==null?void 0:g.types)||[]))}catch(m){console.error("[Bookshelf] Error handling drop:",m)}};a.addEventListener("drop",p,!1),r.forEach(({book:u,file:h})=>{let x=this.app||this.plugin.app,m=new ue(x,u,h,this.plugin).render("grid");a.appendChild(m)}),t.appendChild(a)}async handleBookStatusChange(t,r){try{let i=this.app||this.plugin.app;if(!i)return;let s=i.vault.getAbstractFileByPath(t);if(!s||!(s instanceof Ar.TFile))return;let o=new $(i),a=new G(i),l={status:r};if(r==="reading"&&!(await o.read(s)).readStarted){let{getCurrentDateTime:d}=await Promise.resolve().then(()=>(Q(),Pt));l.readStarted=d()}await a.updateBook(s,l),setTimeout(()=>{this.render()},300)}catch(i){console.error("[Bookshelf] Error changing book status:",i)}}renderEmptyReadingSection(t){let r=t.ownerDocument,i=r.createElement("div");i.className="bookshelf-section-header",i.style.cssText="margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--background-modifier-border);";let s=r.createElement("h2");s.textContent="Reading (0)",s.style.cssText="margin: 0; font-size: 1.5em; font-weight: 600;",i.appendChild(s),t.appendChild(i);let o=r.createElement("div");o.className="bookshelf-section-books bookshelf-layout-grid bookshelf-drop-zone",o.style.cssText="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 40px; min-height: 200px; border: 2px dashed var(--background-modifier-border); border-radius: 8px; text-align: center; color: var(--text-muted); transition: all 0.2s;";let a=r.createElement("p");a.textContent='Drag a book from "To Read" section here to start reading',a.style.cssText="margin: 0; font-size: 14px; font-weight: 500;",o.appendChild(a);let l=r.createElement("p");l.textContent='or click "New Book" to add a new book',l.style.cssText="margin: 8px 0 0 0; font-size: 12px; color: var(--text-faint);",o.appendChild(l),o.addEventListener("dragover",c=>{c.preventDefault(),c.stopPropagation(),c.dataTransfer&&(c.dataTransfer.dropEffect="move"),o.classList.add("drag-over"),o.style.borderColor="var(--interactive-accent)",o.style.backgroundColor="var(--background-modifier-hover)"}),o.addEventListener("dragenter",c=>{c.preventDefault(),c.stopPropagation(),o.classList.add("drag-over"),o.style.borderColor="var(--interactive-accent)",o.style.backgroundColor="var(--background-modifier-hover)"}),o.addEventListener("dragleave",c=>{c.preventDefault(),c.stopPropagation();let d=o.getBoundingClientRect(),p=c.clientX,u=c.clientY;(p<d.left||p>d.right||u<d.top||u>d.bottom)&&(o.classList.remove("drag-over"),o.style.borderColor="var(--background-modifier-border)",o.style.backgroundColor="")}),o.addEventListener("drop",async c=>{var d,p;c.preventDefault(),c.stopPropagation(),o.classList.remove("drag-over"),o.style.borderColor="var(--background-modifier-border)",o.style.backgroundColor="";try{let u=null,h=(d=c.dataTransfer)==null?void 0:d.getData("application/bookshelf-book");if(h)try{u=JSON.parse(h).path}catch(x){}if(!u){let x=(p=c.dataTransfer)==null?void 0:p.getData("text/plain");x&&(u=x)}u?await this.handleBookStatusChange(u,"reading"):console.warn("[Bookshelf] No file path found in drop data")}catch(u){console.error("[Bookshelf] Error handling drop:",u)}}),t.appendChild(o)}renderEmptyUnreadSection(t){let r=t.ownerDocument,i=r.createElement("div");i.className="bookshelf-unread-subsection",i.style.cssText="margin-top: 32px;";let s=r.createElement("div");s.className="bookshelf-subsection-header",s.style.cssText="display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--background-modifier-border);";let o=r.createElement("h3");o.textContent="To Read (0)",o.style.cssText="margin: 0; font-size: 1.1em; font-weight: 500; color: var(--text-muted);",s.appendChild(o),i.appendChild(s);let a=r.createElement("div");a.style.cssText="padding: 20px; text-align: center; color: var(--text-muted);",a.textContent="No unread books.",i.appendChild(a),t.appendChild(i)}renderUnreadSubSection(t,r){let i=t.ownerDocument,s=i.createElement("div");s.className="bookshelf-unread-subsection",s.style.cssText="margin-top: 32px;";let o=i.createElement("div");o.className="bookshelf-subsection-header",o.style.cssText="display: flex; align-items: center; justify-content: space-between; padding: 8px 0; cursor: pointer; border-bottom: 1px solid var(--background-modifier-border);";let a=i.createElement("h3");a.textContent=`To Read (${r.length})`,a.style.cssText="margin: 0; font-size: 1.1em; font-weight: 500; color: var(--text-muted);",o.appendChild(a);let l=i.createElement("span");l.textContent="?",l.style.cssText="font-size: 10px; color: var(--text-muted); transition: transform 0.2s;",o.appendChild(l);let c=i.createElement("div");c.className="bookshelf-unread-list",c.style.cssText="max-height: 300px; overflow-y: auto; margin-top: 8px;";let d=!0,p=()=>{d=!d,c.style.display=d?"block":"none",l.style.transform=d?"rotate(0deg)":"rotate(-90deg)"};o.addEventListener("click",p);let u=i.createElement("ul");u.style.cssText="list-style: none; padding: 0; margin: 0;",r.forEach(({book:h,file:x})=>{let g=i.createElement("li");g.className="bookshelf-unread-item",g.draggable=!0,g.dataset.bookPath=x.path,g.style.cssText="padding: 8px 12px; border-bottom: 1px solid var(--background-modifier-border); cursor: pointer; display: flex; justify-content: space-between; align-items: center;",g.addEventListener("click",k=>{if(k.defaultPrevented)return;let w=this.app||this.plugin.app;w&&w.workspace.openLinkText(x.path,"",!0)});let m=!1,b=k=>{m=!0,g.classList.add("dragging"),k.dataTransfer?(k.dataTransfer.effectAllowed="move",k.dataTransfer.setData("text/plain",x.path),k.dataTransfer.setData("application/bookshelf-book",JSON.stringify({path:x.path,status:"unread"}))):console.error("[Bookshelf] dataTransfer is null in dragstart")};g.addEventListener("dragstart",b,!1),g.addEventListener("dragend",k=>{m=!1,g.classList.remove("dragging"),i.querySelectorAll(".bookshelf-drop-zone").forEach(T=>{T.classList.remove("drag-over")})}),g.addEventListener("click",k=>{if(m){k.preventDefault(),k.stopPropagation(),setTimeout(()=>{m=!1},100);return}});let f=i.createElement("div");f.style.cssText="flex: 1;";let y=i.createElement("div");if(y.textContent=h.title,y.style.cssText="font-weight: 500; font-size: 13px; margin-bottom: 2px;",f.appendChild(y),h.author&&h.author.length>0){let k=i.createElement("div");k.textContent=h.author.join(", "),k.style.cssText="font-size: 11px; color: var(--text-muted);",f.appendChild(k)}g.appendChild(f);let E=i.createElement("span");E.textContent="",E.style.cssText="color: var(--text-faint); font-size: 12px; margin-left: 8px; cursor: grab; user-select: none;",E.title="Drag to Reading section to start reading",E.addEventListener("mousedown",k=>{k.stopPropagation()}),g.appendChild(E),u.appendChild(g)}),c.appendChild(u),s.appendChild(o),s.appendChild(c),t.appendChild(s)}sortBooks(t,r){switch(this.plugin.settings.defaultSort||"date"){case"title":return t.title.localeCompare(r.title);case"author":let s=t.author[0]||"",o=r.author[0]||"";return s.localeCompare(o);case"progress":let a=t.totalPages&&t.readPage?t.readPage/t.totalPages:0;return(r.totalPages&&r.readPage?r.readPage/r.totalPages:0)-a;case"date":default:return new Date(r.created).getTime()-new Date(t.created).getTime()}}renderEmptyState(t){let r=t.ownerDocument,i=r.createElement("div");i.className="bookshelf-empty-state",i.style.cssText="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; text-align: center;";let s=r.createElement("h2");s.className="bookshelf-empty-title",s.textContent="No books added yet",s.style.cssText="margin: 0 0 8px 0; font-size: 1.5em;",i.appendChild(s);let o=r.createElement("p");o.className="bookshelf-empty-description",o.textContent="Start building your bookshelf by searching and adding books.",o.style.cssText="margin: 0 0 24px 0; color: var(--text-muted);",i.appendChild(o);let a=r.createElement("button");a.className="mod-cta",a.textContent="Search and Add Book",a.addEventListener("click",async l=>{l.stopPropagation(),l.preventDefault();let c=this.app||this.plugin.app;if(!c){console.error("[Bookshelf] App not available");return}try{let{SearchModal:d}=await Promise.resolve().then(()=>(ke(),wt));new d(c,this.plugin).open()}catch(d){console.error("[Bookshelf] Error opening search modal:",d)}}),i.appendChild(a),t.appendChild(i)}};var We=class extends H{constructor(){super(...arguments);this.type="bookshelfReadingView";this.books=[]}async render(){var t;if(!(!this.rootElement||!((t=this.data)!=null&&t.data)))try{let r=this.extractDataItems(),i=await this.extractBooksFromBasesData(r);this.books=i.filter(({book:s})=>s.status==="reading"),this.books.sort((s,o)=>{let a=s.book.totalPages&&s.book.readPage?s.book.readPage/s.book.totalPages:0;return(o.book.totalPages&&o.book.readPage?o.book.readPage/o.book.totalPages:0)-a}),this.rootElement.empty(),this.renderContent()}catch(r){console.error("[Bookshelf][ReadingView] Render error:",r),this.renderError(r)}}renderContent(){if(!this.rootElement)return;let t=this.rootElement.ownerDocument,r=t.createElement("div");r.className="bookshelf-header",r.style.cssText="padding: 12px; border-bottom: 1px solid var(--background-modifier-border);";let i=t.createElement("h2");i.textContent=`Reading (${this.books.length})`,i.style.cssText="margin: 0; font-size: 1.2em;",r.appendChild(i),this.rootElement.appendChild(r);let s=t.createElement("div");s.className="bookshelf-books-container bookshelf-layout-grid",s.style.cssText="flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;",this.books.length===0?this.renderEmptyState(s):this.books.forEach(({book:o,file:a})=>{let c=new ue(this.app,o,a,this.plugin).render("grid");s.appendChild(c)}),this.rootElement.appendChild(s)}renderEmptyState(t){let r=t.ownerDocument,i=r.createElement("div");i.className="bookshelf-empty-state",i.style.cssText="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; text-align: center;";let s=r.createElement("div");s.textContent="\u{1F4D6}",s.style.cssText="font-size: 4em; margin-bottom: 16px;",i.appendChild(s);let o=r.createElement("h2");o.textContent="No books being read",o.style.cssText="margin: 0 0 8px 0; font-size: 1.5em;",i.appendChild(o);let a=r.createElement("p");a.textContent="Start reading a book to see it here.",a.style.cssText="margin: 0 0 24px 0; color: var(--text-muted);",i.appendChild(a),t.appendChild(i)}};var Ge=class extends H{constructor(t,r,i){super(t,r,i);this.type="bookshelfLibraryView";this.unreadBooks=[];this.finishedBooks=[]}async render(){var t;if(!(!this.rootElement||!((t=this.data)!=null&&t.data)))try{let r=this.extractDataItems(),i=await this.extractBooksFromBasesData(r);this.unreadBooks=i.filter(({book:s})=>s.status==="unread"),this.finishedBooks=i.filter(({book:s})=>s.status==="finished"),this.unreadBooks.sort((s,o)=>new Date(o.book.created).getTime()-new Date(s.book.created).getTime()),this.finishedBooks.sort((s,o)=>{let a=s.book.readFinished?new Date(s.book.readFinished).getTime():0;return(o.book.readFinished?new Date(o.book.readFinished).getTime():0)-a}),this.rootElement.empty(),this.renderContent()}catch(r){console.error("[Bookshelf][UnreadFinishedView] Render error:",r),this.renderError(r)}}renderContent(){if(!this.rootElement)return;let t=this.rootElement.ownerDocument,r=t.createElement("div");r.className="bookshelf-header",r.style.cssText="padding: 12px; border-bottom: 1px solid var(--background-modifier-border);";let i=t.createElement("h2");i.textContent=`Unread & Finished (${this.unreadBooks.length} unread, ${this.finishedBooks.length} finished)`,i.style.cssText="margin: 0; font-size: 1.2em;",r.appendChild(i),this.rootElement.appendChild(r);let s=t.createElement("div");if(s.style.cssText="flex: 1; overflow-y: auto; padding: 12px;",this.unreadBooks.length>0)this.renderSection(s,t,"Unread Books",this.unreadBooks,"unread");else{let o=t.createElement("div");o.style.cssText="margin-top: 24px;";let a=t.createElement("div");a.style.cssText="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--background-modifier-border);";let l=t.createElement("h3");l.textContent="Unread Books (0)",l.style.cssText="margin: 0; font-size: 1.2em; font-weight: 600;",a.appendChild(l),o.appendChild(a),this.renderEmptyState(o),s.appendChild(o)}if(this.finishedBooks.length>0)this.renderSection(s,t,"Finished Books",this.finishedBooks,"finished");else{let o=t.createElement("div");o.style.cssText="margin-top: 24px;";let a=t.createElement("div");a.style.cssText="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--background-modifier-border);";let l=t.createElement("h3");l.textContent="Finished Books (0)",l.style.cssText="margin: 0; font-size: 1.2em; font-weight: 600;",a.appendChild(l),o.appendChild(a),this.renderEmptyState(o),s.appendChild(o)}this.rootElement.appendChild(s)}renderSection(t,r,i,s,o){let a=r.createElement("div");a.style.cssText="margin-top: 24px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--background-modifier-border);";let l=r.createElement("h3");l.textContent=`${i} (${s.length})`,l.style.cssText="margin: 0; font-size: 1.2em; font-weight: 600;",a.appendChild(l),t.appendChild(a);let c=r.createElement("ul");c.style.cssText="list-style: none; padding: 0; margin: 0;",s.forEach(({book:d,file:p})=>{let u=r.createElement("li");u.style.cssText="padding: 12px; border-bottom: 1px solid var(--background-modifier-border); cursor: pointer;",u.addEventListener("click",g=>{if(g.defaultPrevented)return;let m=this.app||this.plugin.app;m&&m.workspace.openLinkText(p.path,"",!0)});let h=r.createElement("div");if(h.textContent=d.title,h.style.cssText="font-weight: 600; font-size: 14px; margin-bottom: 4px;",u.appendChild(h),d.author&&d.author.length>0){let g=r.createElement("div");g.textContent=d.author.join(", "),g.style.cssText="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;",u.appendChild(g)}let x=r.createElement("div");if(x.style.cssText="font-size: 11px; color: var(--text-faint); display: flex; gap: 12px;",o==="finished"&&d.readFinished){let g=r.createElement("span");g.textContent=`Finished: ${d.readFinished}`,x.appendChild(g)}else if(o==="unread"&&d.created){let g=r.createElement("span");g.textContent=`Added: ${d.created.split(" ")[0]}`,x.appendChild(g)}if(d.totalPages){let g=r.createElement("span");g.textContent=`${d.totalPages} pages`,x.appendChild(g)}u.appendChild(x),c.appendChild(u)}),t.appendChild(c)}renderEmptyState(t){let r=t.ownerDocument,i=r.createElement("div");i.className="bookshelf-empty-state",i.style.cssText="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center;";let s=r.createElement("div");s.className="bookshelf-empty-icon",s.textContent="\u{1F4DA}",s.style.cssText="font-size: 3em; margin-bottom: 12px;",i.appendChild(s);let o=r.createElement("div");o.textContent="No books",o.style.cssText="margin: 0; font-size: 1.1em; color: var(--text-muted);",i.appendChild(o),t.appendChild(i)}};var Ke=class extends H{constructor(t,r,i){super(t,r,i);this.type="bookshelfStatisticsView";this.books=[];this.stats=null}async render(){var t;if(!(!this.rootElement||!((t=this.data)!=null&&t.data)))try{let r=this.extractDataItems();this.books=await this.extractBooksFromBasesData(r),this.stats=await this.calculateStatistics(),this.rootElement.empty(),this.renderContent()}catch(r){console.error("[Bookshelf][StatisticsView] Render error:",r),this.renderError(r)}}async calculateStatistics(){let t={totalBooks:this.books.length,reading:0,unread:0,finished:0,totalPages:0,readPages:0,totalReadingDays:0,averageTimeToFinish:0,categoryCounts:{},yearlyStats:{},monthlyStats:{}},r=[],i=new Set;for(let{book:a,file:l}of this.books){if(a.status==="reading"?t.reading++:a.status==="unread"?t.unread++:a.status==="finished"&&(t.finished++,r.push(a)),a.totalPages&&(t.totalPages+=a.totalPages),a.readPage&&(t.readPages+=a.readPage),a.status==="finished"&&a.category&&a.category.length>0&&a.category.forEach(c=>{t.categoryCounts[c]=(t.categoryCounts[c]||0)+1}),a.status==="finished"&&a.readFinished){let c=new Date(a.readFinished),d=c.getFullYear().toString(),p=`${d}-${String(c.getMonth()+1).padStart(2,"0")}`;t.yearlyStats[d]||(t.yearlyStats[d]={count:0,pages:0,readingDays:0,averageTimeToFinish:0}),t.yearlyStats[d].count++,a.totalPages&&(t.yearlyStats[d].pages+=a.totalPages),t.monthlyStats[p]||(t.monthlyStats[p]={count:0,pages:0,readingDays:0,averageTimeToFinish:0}),t.monthlyStats[p].count++,a.totalPages&&(t.monthlyStats[p].pages+=a.totalPages);let u=new Set;if(a.readStarted){let g=new Date(a.readStarted).toISOString().split("T")[0];g&&u.add(g)}try{let x=await this.plugin.app.vault.read(l),{FrontmatterParser:g}=await Promise.resolve().then(()=>(V(),le)),{frontmatter:m}=g.extract(x),b=m.reading_history_summary;b&&Array.isArray(b)&&b.forEach(f=>{f&&typeof f=="object"&&"date"in f&&typeof f.date=="string"&&u.add(f.date)})}catch(x){}let h=u.size;t.yearlyStats[d].readingDays+=h,t.yearlyStats[d].averageTimeToFinish+=h,t.monthlyStats[p].readingDays+=h,t.monthlyStats[p].averageTimeToFinish+=h}if(a.readStarted&&l){let d=new Date(a.readStarted).toISOString().split("T")[0];d&&i.add(d);try{let p=await this.plugin.app.vault.read(l),{FrontmatterParser:u}=await Promise.resolve().then(()=>(V(),le)),{frontmatter:h}=u.extract(p),x=h.reading_history_summary;x&&Array.isArray(x)&&x.forEach(g=>{g&&typeof g=="object"&&"date"in g&&typeof g.date=="string"&&i.add(g.date)})}catch(p){}}}t.totalReadingDays=i.size;let s=Object.keys(t.yearlyStats).sort();for(let a=0;a<s.length;a++){let l=s[a];if(!l)continue;let c=t.yearlyStats[l];if(c&&(c.count>0&&(c.averageTimeToFinish=Math.round(c.averageTimeToFinish/c.count)),a>0)){let d=s[a-1],p=d?t.yearlyStats[d]:null;p&&(c.change=c.count-p.count,c.changePercent=p.count>0?Math.round(c.change/p.count*100):c.count>0?100:0)}}let o=Object.keys(t.monthlyStats).sort();for(let a=0;a<o.length;a++){let l=o[a];if(!l)continue;let c=t.monthlyStats[l];if(c&&(c.count>0&&(c.averageTimeToFinish=Math.round(c.averageTimeToFinish/c.count)),a>0)){let d=o[a-1],p=d?t.monthlyStats[d]:null;p&&(c.change=c.count-p.count,c.changePercent=p.count>0?Math.round(c.change/p.count*100):c.count>0?100:0)}}if(r.length>0){let a=0,l=0;for(let c of this.books)if(c.book.status==="finished")try{let d=await this.plugin.app.vault.read(c.file),{FrontmatterParser:p}=await Promise.resolve().then(()=>(V(),le)),{frontmatter:u}=p.extract(d),h=u.reading_history_summary,x=new Set;if(c.book.readStarted){let b=new Date(c.book.readStarted).toISOString().split("T")[0];b&&x.add(b)}h&&Array.isArray(h)&&h.forEach(m=>{m&&typeof m=="object"&&"date"in m&&typeof m.date=="string"&&x.add(m.date)});let g=x.size;g>0&&(a+=g,l++)}catch(d){}t.averageTimeToFinish=l>0?Math.round(a/l):0}return t}renderContent(){if(!this.rootElement||!this.stats)return;let t=this.rootElement.ownerDocument,r=t.createElement("div");r.style.cssText="padding: 20px; overflow-y: auto; height: 100%;";let i=t.createElement("h1");i.textContent="Reading statistics",i.style.cssText="margin: 0 0 32px 0; font-size: 1.8em;",r.appendChild(i),this.renderOverallSection(r,t),this.renderTimeBasedSection(r,t),this.renderCategorySection(r,t),this.rootElement.appendChild(r)}renderOverallSection(t,r){let i=r.createElement("div");i.style.cssText="margin-bottom: 40px;";let s=r.createElement("h2");s.textContent="Overall statistics",s.style.cssText="margin: 0 0 16px 0; font-size: 1.4em; padding-bottom: 8px; border-bottom: 2px solid var(--background-modifier-border);",i.appendChild(s);let o=r.createElement("div");o.style.cssText="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 16px;",[{label:"Total finished books",value:this.stats.finished,color:"var(--interactive-success)"},{label:"Total pages read",value:this.stats.readPages.toLocaleString(),color:"var(--interactive-accent)"},{label:"Total reading days",value:this.stats.totalReadingDays,color:"var(--text-accent)"}].forEach(u=>{let h=r.createElement("div");h.style.cssText="padding: 20px; border-radius: 8px; background: var(--background-secondary); border: 1px solid var(--background-modifier-border);";let x=r.createElement("div");x.textContent=u.label,x.style.cssText="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;";let g=r.createElement("div");g.textContent=u.value.toString(),g.style.cssText=`font-size: 28px; font-weight: 600; color: ${u.color};`,h.appendChild(x),h.appendChild(g),o.appendChild(h)}),i.appendChild(o);let l=r.createElement("div");l.style.cssText="padding: 20px; border-radius: 8px; background: var(--background-secondary); border: 1px solid var(--background-modifier-border);";let c=r.createElement("div");c.textContent="Average days to finish",c.style.cssText="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;";let d=r.createElement("div");d.textContent="Average number of reading sessions to complete a book",d.style.cssText="font-size: 10px; color: var(--text-faint); margin-bottom: 8px;";let p=r.createElement("div");p.textContent=this.stats.averageTimeToFinish>0?`${this.stats.averageTimeToFinish} sessions`:"No data available",p.style.cssText="font-size: 28px; font-weight: 600; color: var(--interactive-accent);",l.appendChild(c),l.appendChild(d),l.appendChild(p),i.appendChild(l),t.appendChild(i)}renderTimeBasedSection(t,r){let i=r.createElement("div");i.style.cssText="margin-bottom: 40px;";let s=r.createElement("div");s.style.cssText="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--background-modifier-border);";let o=r.createElement("h2");o.textContent="Time-based statistics",o.style.cssText="margin: 0; font-size: 1.4em;",s.appendChild(o);let a=r.createElement("div");a.style.cssText="display: flex; gap: 4px; background: var(--background-secondary); border-radius: 6px; padding: 4px;";let l=r.createElement("button");l.textContent="Yearly",l.style.cssText="padding: 6px 16px; border: none; border-radius: 4px; background: var(--interactive-accent); color: var(--text-on-accent); font-size: 13px; font-weight: 600; cursor: pointer;";let c=r.createElement("button");c.textContent="Monthly",c.style.cssText="padding: 6px 16px; border: none; border-radius: 4px; background: transparent; color: var(--text-muted); font-size: 13px; font-weight: 600; cursor: pointer;",a.appendChild(l),a.appendChild(c),s.appendChild(a),i.appendChild(s);let d=r.createElement("div");d.style.cssText="position: relative;",this.renderYearlyContent(d,r),l.addEventListener("click",()=>{l.style.cssText="padding: 6px 16px; border: none; border-radius: 4px; background: var(--interactive-accent); color: var(--text-on-accent); font-size: 13px; font-weight: 600; cursor: pointer;",c.style.cssText="padding: 6px 16px; border: none; border-radius: 4px; background: transparent; color: var(--text-muted); font-size: 13px; font-weight: 600; cursor: pointer;",d.empty(),this.renderYearlyContent(d,r)}),c.addEventListener("click",()=>{c.style.cssText="padding: 6px 16px; border: none; border-radius: 4px; background: var(--interactive-accent); color: var(--text-on-accent); font-size: 13px; font-weight: 600; cursor: pointer;",l.style.cssText="padding: 6px 16px; border: none; border-radius: 4px; background: transparent; color: var(--text-muted); font-size: 13px; font-weight: 600; cursor: pointer;",d.empty(),this.renderMonthlyContent(d,r)}),i.appendChild(d),t.appendChild(i)}renderYearlyContent(t,r){let i=Object.keys(this.stats.yearlyStats).sort().reverse();if(i.length===0){let b=r.createElement("div");b.style.cssText="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;",["Finished books","Pages read","Reading days"].forEach(f=>{let y=r.createElement("div");y.style.cssText="padding: 16px; background: var(--background-secondary); border-radius: 8px; border: 1px solid var(--background-modifier-border);";let E=r.createElement("h3");E.textContent=f,E.style.cssText="margin: 0 0 12px 0; font-size: 0.9em; color: var(--text-muted);",y.appendChild(E);let k=r.createElement("div");k.style.cssText="height: 200px; position: relative;",this.renderEmptyChart(k,r,"Year"),y.appendChild(k),b.appendChild(y)}),t.appendChild(b);return}let s=r.createElement("div");s.style.cssText="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 16px;";let o=r.createElement("div");o.style.cssText="padding: 16px; background: var(--background-secondary); border-radius: 8px; border: 1px solid var(--background-modifier-border);";let a=r.createElement("h3");a.textContent="Finished books",a.style.cssText="margin: 0 0 12px 0; font-size: 0.9em; color: var(--text-muted);",o.appendChild(a);let l=r.createElement("div");l.style.cssText="height: 200px; position: relative;",this.renderLineChart(l,r,i.map(b=>{let f=this.stats.yearlyStats[b];return{label:b,value:f?f.count:0,change:f==null?void 0:f.change,changePercent:f==null?void 0:f.changePercent}}),"Year"),o.appendChild(l),s.appendChild(o);let c=r.createElement("div");c.style.cssText="padding: 16px; background: var(--background-secondary); border-radius: 8px; border: 1px solid var(--background-modifier-border);";let d=r.createElement("h3");d.textContent="Pages read",d.style.cssText="margin: 0 0 12px 0; font-size: 0.9em; color: var(--text-muted);",c.appendChild(d);let p=r.createElement("div");p.style.cssText="height: 200px; position: relative;",this.renderLineChart(p,r,i.map(b=>{let f=this.stats.yearlyStats[b];return{label:b,value:f?f.pages:0}}),"Year"),c.appendChild(p),s.appendChild(c);let u=r.createElement("div");u.style.cssText="padding: 16px; background: var(--background-secondary); border-radius: 8px; border: 1px solid var(--background-modifier-border);";let h=r.createElement("h3");h.textContent="Reading days",h.style.cssText="margin: 0 0 12px 0; font-size: 0.9em; color: var(--text-muted);",u.appendChild(h);let x=r.createElement("div");x.style.cssText="height: 200px; position: relative;",this.renderLineChart(x,r,i.map(b=>{let f=this.stats.yearlyStats[b];return{label:b,value:f?f.readingDays:0}}),"Year"),u.appendChild(x),s.appendChild(u),t.appendChild(s);let g=r.createElement("div");g.style.cssText="padding: 16px; background: var(--background-secondary); border-radius: 8px; border: 1px solid var(--background-modifier-border);";let m=r.createElement("h3");m.textContent="Details",m.style.cssText="margin: 0 0 12px 0; font-size: 0.9em; color: var(--text-muted);",g.appendChild(m),i.forEach(b=>{let f=this.stats.yearlyStats[b];if(!f)return;let y=r.createElement("div");y.style.cssText="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--background-modifier-border);";let E=r.createElement("div");E.style.cssText="display: flex; flex-direction: column; gap: 4px;";let k=r.createElement("span");if(k.textContent=b,k.style.cssText="font-size: 14px; font-weight: 600;",E.appendChild(k),f.change!==void 0&&f.changePercent!==void 0){let U=r.createElement("span"),J=f.change>=0,te=J?`+${f.change}`:`${f.change}`,he=J?`+${f.changePercent}%`:`${f.changePercent}%`;U.textContent=`${te} (${he})`,U.style.cssText=`font-size: 11px; color: ${J?"var(--interactive-success)":"var(--text-error)"};`,E.appendChild(U)}let w=r.createElement("div");w.style.cssText="display: flex; flex-direction: column; gap: 2px; align-items: flex-end;";let T=r.createElement("span");T.textContent=`${f.count} books, ${f.pages.toLocaleString()} pages`,T.style.cssText="font-size: 14px; color: var(--text-muted);";let D=r.createElement("span");D.textContent=`${f.readingDays} reading days, Avg: ${f.averageTimeToFinish} sessions`,D.style.cssText="font-size: 11px; color: var(--text-faint);",w.appendChild(T),w.appendChild(D),y.appendChild(E),y.appendChild(w),g.appendChild(y)}),t.appendChild(g)}renderMonthlyContent(t,r){let i=Object.keys(this.stats.monthlyStats).sort().reverse().slice(0,12);if(i.length===0){let b=r.createElement("div");b.style.cssText="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;",["Finished books (Last 12)","Pages read (Last 12)","Reading days (Last 12)"].forEach(f=>{let y=r.createElement("div");y.style.cssText="padding: 16px; background: var(--background-secondary); border-radius: 8px; border: 1px solid var(--background-modifier-border);";let E=r.createElement("h3");E.textContent=f,E.style.cssText="margin: 0 0 12px 0; font-size: 0.9em; color: var(--text-muted);",y.appendChild(E);let k=r.createElement("div");k.style.cssText="height: 200px; position: relative;",this.renderEmptyChart(k,r,"Month"),y.appendChild(k),b.appendChild(y)}),t.appendChild(b);return}let s=r.createElement("div");s.style.cssText="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 16px;";let o=r.createElement("div");o.style.cssText="padding: 16px; background: var(--background-secondary); border-radius: 8px; border: 1px solid var(--background-modifier-border);";let a=r.createElement("h3");a.textContent="Finished books (Last 12)",a.style.cssText="margin: 0 0 12px 0; font-size: 0.9em; color: var(--text-muted);",o.appendChild(a);let l=r.createElement("div");l.style.cssText="height: 200px; position: relative;",this.renderLineChart(l,r,i.map(b=>{let f=this.stats.monthlyStats[b],y=b.split("-"),E=y[0]||"",k=y[1]||"1";return{label:`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][parseInt(k)-1]||"Jan"} ${E}`,value:f?f.count:0,change:f==null?void 0:f.change,changePercent:f==null?void 0:f.changePercent}}),"Month"),o.appendChild(l),s.appendChild(o);let c=r.createElement("div");c.style.cssText="padding: 16px; background: var(--background-secondary); border-radius: 8px; border: 1px solid var(--background-modifier-border);";let d=r.createElement("h3");d.textContent="Pages read (Last 12)",d.style.cssText="margin: 0 0 12px 0; font-size: 0.9em; color: var(--text-muted);",c.appendChild(d);let p=r.createElement("div");p.style.cssText="height: 200px; position: relative;",this.renderLineChart(p,r,i.map(b=>{let f=this.stats.monthlyStats[b],y=b.split("-"),E=y[0]||"",k=y[1]||"1";return{label:`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][parseInt(k)-1]||"Jan"} ${E}`,value:f?f.pages:0}}),"Month"),c.appendChild(p),s.appendChild(c);let u=r.createElement("div");u.style.cssText="padding: 16px; background: var(--background-secondary); border-radius: 8px; border: 1px solid var(--background-modifier-border);";let h=r.createElement("h3");h.textContent="Reading days (Last 12)",h.style.cssText="margin: 0 0 12px 0; font-size: 0.9em; color: var(--text-muted);",u.appendChild(h);let x=r.createElement("div");x.style.cssText="height: 200px; position: relative;",this.renderLineChart(x,r,i.map(b=>{let f=this.stats.monthlyStats[b],y=b.split("-"),E=y[0]||"",k=y[1]||"1";return{label:`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][parseInt(k)-1]||"Jan"} ${E}`,value:f?f.readingDays:0}}),"Month"),u.appendChild(x),s.appendChild(u),t.appendChild(s);let g=r.createElement("div");g.style.cssText="padding: 16px; background: var(--background-secondary); border-radius: 8px; border: 1px solid var(--background-modifier-border);";let m=r.createElement("h3");m.textContent="Details",m.style.cssText="margin: 0 0 12px 0; font-size: 0.9em; color: var(--text-muted);",g.appendChild(m),i.forEach(b=>{let f=this.stats.monthlyStats[b];if(!f)return;let y=b.split("-"),E=y[0]||"",k=y[1]||"1",T=`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][parseInt(k)-1]||"Jan"} ${E}`,D=r.createElement("div");D.style.cssText="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--background-modifier-border);";let U=r.createElement("div");U.style.cssText="display: flex; flex-direction: column; gap: 4px;";let J=r.createElement("span");if(J.textContent=T,J.style.cssText="font-size: 14px; font-weight: 600;",U.appendChild(J),f.change!==void 0&&f.changePercent!==void 0){let tt=r.createElement("span"),rt=f.change>=0,Dr=rt?`+${f.change}`:`${f.change}`,Lr=rt?`+${f.changePercent}%`:`${f.changePercent}%`;tt.textContent=`${Dr} (${Lr})`,tt.style.cssText=`font-size: 11px; color: ${rt?"var(--interactive-success)":"var(--text-error)"};`,U.appendChild(tt)}let te=r.createElement("div");te.style.cssText="display: flex; flex-direction: column; gap: 2px; align-items: flex-end;";let he=r.createElement("span");he.textContent=`${f.count} books, ${f.pages.toLocaleString()} pages`,he.style.cssText="font-size: 14px; color: var(--text-muted);";let et=r.createElement("span");et.textContent=`${f.readingDays} reading days, Avg: ${f.averageTimeToFinish} sessions`,et.style.cssText="font-size: 11px; color: var(--text-faint);",te.appendChild(he),te.appendChild(et),D.appendChild(U),D.appendChild(te),g.appendChild(D)}),t.appendChild(g)}renderCategorySection(t,r){let i=r.createElement("div");i.style.cssText="margin-bottom: 40px;";let s=r.createElement("h2");s.textContent="Category statistics",s.style.cssText="margin: 0 0 16px 0; font-size: 1.4em; padding-bottom: 8px; border-bottom: 2px solid var(--background-modifier-border);",i.appendChild(s);let o=Object.entries(this.stats.categoryCounts).sort((d,p)=>p[1]-d[1]).slice(0,10),a=r.createElement("div");a.style.cssText="padding: 16px; background: var(--background-secondary); border-radius: 8px; border: 1px solid var(--background-modifier-border); max-width: 600px;";let l=r.createElement("h3");l.textContent="Books by category (Top 10)",l.style.cssText="margin: 0 0 12px 0; font-size: 0.9em; color: var(--text-muted);",a.appendChild(l);let c=r.createElement("div");c.style.cssText="height: 200px; position: relative;",o.length===0?this.renderEmptyChart(c,r,"Category"):this.renderBarChart(c,r,o.map(([d,p])=>({label:d,value:p}))),a.appendChild(c),i.appendChild(a),t.appendChild(i)}renderBarChart(t,r,i){if(i.length===0)return;let s=Math.max(...i.map(d=>d.value),1),o=180,a=40,l=12,c=r.createElementNS("http://www.w3.org/2000/svg","svg");c.setAttribute("width","100%"),c.setAttribute("height",`${o}px`),c.style.cssText="display: block;",i.forEach((d,p)=>{let u=d.value/s*(o-40),h=p*(a+l)+10,x=o-u-20,g=r.createElementNS("http://www.w3.org/2000/svg","rect");if(g.setAttribute("x",h.toString()),g.setAttribute("y",x.toString()),g.setAttribute("width",a.toString()),g.setAttribute("height",u.toString()),g.setAttribute("fill","var(--interactive-accent)"),g.setAttribute("rx","4"),c.appendChild(g),d.value>0){let b=r.createElementNS("http://www.w3.org/2000/svg","text");b.setAttribute("x",(h+a/2).toString()),b.setAttribute("y",(x-5).toString()),b.setAttribute("text-anchor","middle"),b.setAttribute("font-size","12"),b.setAttribute("fill","var(--text-normal)"),b.textContent=d.value.toString(),c.appendChild(b)}let m=r.createElementNS("http://www.w3.org/2000/svg","text");m.setAttribute("x",(h+a/2).toString()),m.setAttribute("y",(o-5).toString()),m.setAttribute("text-anchor","middle"),m.setAttribute("font-size","10"),m.setAttribute("fill","var(--text-muted)"),m.textContent=d.label.length>7?d.label.substring(0,7)+"...":d.label,c.appendChild(m)}),t.appendChild(c)}renderLineChart(t,r,i,s){if(i.length===0)return;let o=[...i].reverse(),a=Math.max(...o.map(m=>m.value),1),l=200,c=t.clientWidth||600,d=40,p=c-d*2,u=l-d*2,h=r.createElementNS("http://www.w3.org/2000/svg","svg");h.setAttribute("width","100%"),h.setAttribute("height",`${l}px`),h.style.cssText="display: block;";let x=[];if(o.forEach((m,b)=>{let f=d+b/(o.length-1||1)*p,y=d+u-m.value/a*u;x.push(`${f},${y}`)}),x.length>1){let m=r.createElementNS("http://www.w3.org/2000/svg","path");m.setAttribute("d",`M ${x.join(" L ")}`),m.setAttribute("fill","none"),m.setAttribute("stroke","var(--interactive-accent)"),m.setAttribute("stroke-width","2"),m.setAttribute("stroke-linecap","round"),m.setAttribute("stroke-linejoin","round"),h.appendChild(m)}o.forEach((m,b)=>{let f=d+b/(o.length-1||1)*p,y=d+u-m.value/a*u,E=r.createElementNS("http://www.w3.org/2000/svg","circle");if(E.setAttribute("cx",f.toString()),E.setAttribute("cy",y.toString()),E.setAttribute("r","4"),E.setAttribute("fill","var(--interactive-accent)"),h.appendChild(E),m.value>0){let w=r.createElementNS("http://www.w3.org/2000/svg","text");w.setAttribute("x",f.toString()),w.setAttribute("y",(y-10).toString()),w.setAttribute("text-anchor","middle"),w.setAttribute("font-size","11"),w.setAttribute("fill","var(--text-normal)"),w.setAttribute("font-weight","600"),w.textContent=m.value.toString(),h.appendChild(w)}if(m.change!==void 0&&m.change!==0){let w=m.change>0,T=y-20,D=r.createElementNS("http://www.w3.org/2000/svg","path");w?D.setAttribute("d",`M ${f} ${T} L ${f-4} ${T+6} L ${f+4} ${T+6} Z`):D.setAttribute("d",`M ${f} ${T+6} L ${f-4} ${T} L ${f+4} ${T} Z`),D.setAttribute("fill",w?"var(--interactive-success)":"var(--text-error)"),h.appendChild(D)}let k=r.createElementNS("http://www.w3.org/2000/svg","text");k.setAttribute("x",f.toString()),k.setAttribute("y",(l-10).toString()),k.setAttribute("text-anchor","middle"),k.setAttribute("font-size","9"),k.setAttribute("fill","var(--text-muted)"),k.textContent=m.label.length>8?m.label.substring(0,8)+"...":m.label,h.appendChild(k)});let g=5;for(let m=0;m<=g;m++){let b=a/g*m,f=d+u-m/g*u,y=r.createElementNS("http://www.w3.org/2000/svg","line");y.setAttribute("x1",d.toString()),y.setAttribute("y1",f.toString()),y.setAttribute("x2",(d+p).toString()),y.setAttribute("y2",f.toString()),y.setAttribute("stroke","var(--background-modifier-border)"),y.setAttribute("stroke-width","1"),y.setAttribute("stroke-dasharray","2,2"),h.insertBefore(y,h.firstChild);let E=r.createElementNS("http://www.w3.org/2000/svg","text");E.setAttribute("x",(d-5).toString()),E.setAttribute("y",(f+4).toString()),E.setAttribute("text-anchor","end"),E.setAttribute("font-size","9"),E.setAttribute("fill","var(--text-muted)"),E.textContent=Math.round(b).toString(),h.insertBefore(E,h.firstChild)}t.appendChild(h)}renderEmptyChart(t,r,i){let o=t.clientWidth||600,a=40,l=o-a*2,c=200-a*2,d=r.createElementNS("http://www.w3.org/2000/svg","svg");d.setAttribute("width","100%"),d.setAttribute("height","200px"),d.style.cssText="display: block;";let p=5;for(let g=0;g<=p;g++){let m=g,b=a+c-g/p*c,f=r.createElementNS("http://www.w3.org/2000/svg","line");f.setAttribute("x1",a.toString()),f.setAttribute("y1",b.toString()),f.setAttribute("x2",(a+l).toString()),f.setAttribute("y2",b.toString()),f.setAttribute("stroke","var(--background-modifier-border)"),f.setAttribute("stroke-width","1"),f.setAttribute("stroke-dasharray","2,2"),d.appendChild(f);let y=r.createElementNS("http://www.w3.org/2000/svg","text");y.setAttribute("x",(a-5).toString()),y.setAttribute("y",(b+4).toString()),y.setAttribute("text-anchor","end"),y.setAttribute("font-size","9"),y.setAttribute("fill","var(--text-muted)"),y.textContent=m.toString(),d.appendChild(y)}let u=r.createElementNS("http://www.w3.org/2000/svg","line");u.setAttribute("x1",a.toString()),u.setAttribute("y1",(a+c).toString()),u.setAttribute("x2",(a+l).toString()),u.setAttribute("y2",(a+c).toString()),u.setAttribute("stroke","var(--text-muted)"),u.setAttribute("stroke-width","1"),d.appendChild(u);let h=r.createElementNS("http://www.w3.org/2000/svg","line");h.setAttribute("x1",a.toString()),h.setAttribute("y1",a.toString()),h.setAttribute("x2",a.toString()),h.setAttribute("y2",(a+c).toString()),h.setAttribute("stroke","var(--text-muted)"),h.setAttribute("stroke-width","1"),d.appendChild(h);let x=r.createElementNS("http://www.w3.org/2000/svg","text");x.setAttribute("x",(a+l/2).toString()),x.setAttribute("y",(a+c/2).toString()),x.setAttribute("text-anchor","middle"),x.setAttribute("font-size","14"),x.setAttribute("fill","var(--text-muted)"),x.setAttribute("font-style","italic"),x.textContent="No data available",d.appendChild(x),t.appendChild(d)}};async function Pr(e){if(!(0,Br.requireApiVersion)("1.10.1")){console.warn("[Bookshelf][Bases] Obsidian 1.10.1+ required for Bases integration");return}let n=async()=>{try{let t=Ee(e,"bookshelfView",{name:"Bookshelf View",icon:"book-open",factory:(o,a)=>new qe(o,a,e)}),r=Ee(e,"bookshelfReadingView",{name:"Reading Books",icon:"book-open-text",factory:(o,a)=>new We(o,a,e)}),i=Ee(e,"bookshelfLibraryView",{name:"Library",icon:"library",factory:(o,a)=>new Ge(o,a,e)}),s=Ee(e,"bookshelfStatisticsView",{name:"Reading Statistics",icon:"bar-chart",factory:(o,a)=>new Ke(o,a,e)});return!t&&!r&&!i&&!s?(console.debug("[Bookshelf][Bases] Bases plugin not available for registration"),!1):(e.app.workspace.iterateAllLeaves(o=>{var a,l;if(((l=(a=o.view)==null?void 0:a.getViewType)==null?void 0:l.call(a))==="bases"){let c=o.view;if(typeof c.refresh=="function")try{c.refresh()}catch(d){console.debug("[Bookshelf][Bases] Error refreshing view:",d)}}}),!0)}catch(t){return console.warn("[Bookshelf][Bases] Registration attempt failed:",t),!1}};if(!await n()){for(let t=0;t<5;t++)if(await new Promise(r=>setTimeout(r,200)),await n())return;console.warn("[Bookshelf][Bases] Failed to register views after multiple attempts")}}function Fr(e){try{we(e,"bookshelfView"),we(e,"bookshelfReadingView"),we(e,"bookshelfLibraryView"),we(e,"bookshelfStatisticsView")}catch(n){console.error("[Bookshelf][Bases] Error during view unregistration:",n)}}var Je=class{static generate(n){return`filters:
  and:
    - file.path.startsWith("${`${n.bookFolder}/Books`}/")
    - file.path.endsWith(".md")
    - note.status == "reading" || note.status == "unread"

order:
  - note.status
  - note.read_page
  - file.ctime

columns:
  - id: file.name
    display-name: Title
    type: text
  - id: note.author
    display-name: Author
    type: list
  - id: note.status
    display-name: Status
    type: text
  - id: note.read_page
    display-name: Progress
    type: number
  - id: note.total
    display-name: Total Pages
    type: number

views:
  - type: bookshelfView
    name: Bookshelf
`}};var Qe=class{static generate(n){return`filters:
  and:
    - file.path.startsWith("${`${n.bookFolder}/Books`}/")
    - file.path.endsWith(".md")
    - note.status == "unread" || note.status == "finished"

order:
  - note.status
  - file.ctime

columns:
  - id: file.name
    display-name: Title
    type: text
  - id: note.author
    display-name: Author
    type: list
  - id: note.status
    display-name: Status
    type: text
  - id: note.total
    display-name: Total Pages
    type: number
  - id: file.ctime
    display-name: Added
    type: date
  - id: note.read_finished
    display-name: Finished
    type: date

views:
  - type: bookshelfLibraryView
    name: Library
`}};var Ze=class{static generate(n){return`filters:
  and:
    - file.path.startsWith("${`${n.bookFolder}/Books`}/")
    - file.path.endsWith(".md")

views:
  - type: bookshelfStatisticsView
    name: Statistics
`}};var Xe=class extends I.Plugin{async onload(){await this.loadSettings(),De(this.settings.timezone);let n=new re(this.app);try{await n.ensureFolder(this.settings.bookFolder),await n.ensureFolder(L.getBooksFolderPath(this.settings.bookFolder)),await n.ensureFolder(L.getInteractionFolderPath(this.settings.bookFolder)),await n.ensureFolder(L.getViewsFolderPath(this.settings.bookFolder)),await this.ensureDefaultBaseFiles()}catch(r){console.error("Failed to initialize Bookshelf folders:",r)}this.addSettingTab(new Te(this.app,this)),Sr(this.app,this),await Pr(this),this.addCommand({id:"open-view",name:"Open view",callback:()=>{this.activateView()}}),this.addRibbonIcon("book-open-text","Open bookshelf",()=>{this.activateView()}),this.addRibbonIcon("book-plus","Search and add book",()=>{new ee(this.app,this).open()}),this.registerEvent(this.app.workspace.on("file-open",r=>{r instanceof I.TFile&&this.addProgressButtonToNote(r)}));let t=this.app.workspace.getActiveFile();t&&this.addProgressButtonToNote(t),this.settings.autoUpdateTimestamp&&this.registerAutoUpdateTimestamp()}async addProgressButtonToNote(n){if(!n||n.extension!=="md")return;let t=L.getBooksFolderPath(this.settings.bookFolder);n.path.startsWith(t)&&setTimeout(()=>{let r=this.app.workspace.getActiveViewOfType(I.MarkdownView);if(!r)return;let i=r.containerEl;if(!i)return;let s=i.querySelector(".bookshelf-action-container");if(!s){let a=i.querySelector(".view-header")||i.querySelector(".view-header-title-container");if(a)s=a;else{let l=i.querySelector(".markdown-source-view")||i.querySelector(".markdown-preview-view");if(!l)return;let c=l.createEl("div",{cls:"bookshelf-action-container"});l.firstChild&&l.insertBefore(c,l.firstChild),s=c}}if(s.querySelector(".bookshelf-progress-button"))return;s.createEl("button",{cls:"bookshelf-progress-button mod-cta",text:"Update progress"}).addEventListener("click",()=>{let a=this.app.workspace.getActiveFile();a&&new K(this.app,this,a).open()})},200)}onunload(){Fr(this)}registerAutoUpdateTimestamp(){let n=L.getBooksFolderPath(this.settings.bookFolder);this.registerEvent(this.app.vault.on("modify",async t=>{if(!(!(t instanceof I.TFile)||t.extension!=="md"||!t.path.startsWith(n))&&this.settings.autoUpdateTimestamp)try{let r=await this.app.vault.read(t),{frontmatter:i,body:s}=O.extract(r);if(!i.title)return;i.updated=R();let a=`${Y.create(i)}
${s}`;r!==a&&await this.app.vault.modify(t,a)}catch(r){console.debug("Auto-update timestamp error:",r)}}))}async activateView(){let{workspace:n}=this.app,t=L.getViewsFolderPath(this.settings.bookFolder),r=(0,I.normalizePath)(`${t}/bookshelf-default.base`),i=this.app.vault.getAbstractFileByPath(r);if(i&&i instanceof I.TFile){let s=n.getRightLeaf(!1)||n.getLeaf(!0);await s.openFile(i),n.revealLeaf(s)}}async ensureDefaultBaseFiles(){let n=L.getViewsFolderPath(this.settings.bookFolder),t=[{path:`${n}/bookshelf-default.base`,generator:Je},{path:`${n}/library.base`,generator:Qe},{path:`${n}/statistics.base`,generator:Ze}];for(let{path:r,generator:i}of t){let s=(0,I.normalizePath)(r);if(!this.app.vault.getAbstractFileByPath(s))try{let a=i.generate(this.settings);await this.app.vault.create(s,a)}catch(a){console.error(`[Bookshelf] Failed to create ${s}:`,a)}}}async loadSettings(){this.settings=Object.assign({},Ct,await this.loadData())}async saveSettings(){await this.saveData(this.settings),De(this.settings.timezone)}};
/*! Bundled license information:

js-yaml/dist/js-yaml.mjs:
  (*! js-yaml 4.1.1 https://github.com/nodeca/js-yaml @license MIT *)
*/
